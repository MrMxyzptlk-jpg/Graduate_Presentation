<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espectros de Absorci√≥n √ìptica y de Rayos X</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js" defer ></script>
    <script src="presentation_data.js" ></script>

    <style>
        :root {

            /* UI Elements */
                --bg-color: #000;
                --bg2-color: #111;
                --border-color: rgba(255, 255, 255, 0.1);
                --shadow-color: rgba(222, 255, 154, 0.05);
                --axes-color: #cbd5f5;
                --text-color: #ffffff;

                --highlight1-color: #E26EE5;
                --highlight2-color: #A3D8FF;

                --curve1-color: #00F5FF
                ;
                --curve2-color: #FFF024;
                --curve3-color: #16FF00;
                --curve4-color: #FF6363;
                --curve5-color: #F67FF5;

                --arrow-color: #A5158C;

            /* Particles & Physics (For CSS use) */
                --lattice-color: #666666;
                --particle-photon: #ffffaa;
                --particle-electron: #4d4dff;
                --particle-ion: #ff4d4d;

            }

        /* --- CORE STYLES --- */
        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-color); margin: 0; padding: 0;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: 'Urbanist', sans-serif; color: var(--text-color);
        }

        #presentation-container { position: relative; width: 100%; height: 100%; }

        .slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out;
            display: flex; justify-content: center; align-items: center; z-index: 1;
            /* Add this to hint the browser to promote this to a GPU layer */
            will-change: opacity, visibility;
        }

        .slide.active { opacity: 1; visibility: visible; z-index: 2; }

        .slide-content {
            background-color: var(--bg-color); width: 90%; max-width: 1400px; height: 85%;
            border-radius: 12px; padding: 50px 70px; position: relative;
            box-shadow: 0 0 50px var(--shadow-color);
            border: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }

        /* TEXT HIGHLIGHTING LOGIC */
        .step-text {
            color: var(--text-color);
            opacity: 1.0;
            transition: all 0.5s ease;
        }

        .step-text.active {
            color: var(--highlight1-color); /* Green */
            opacity: 1;
            text-shadow: 0 0 15px var(--shadow-color);
        }

        /* OVERLAY SYSTEM */
        .slide-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 50px 70px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease, transform 0.6s ease;
            opacity: 1;
            transform: scale(1);
            background-color: var(--bg-color);
            z-index: 10;
        }

        .slide-layer.hidden {
            opacity: 0;
           /* pointer-events: none;*/
            transform: scale(0.95);
            z-index: 0;
        }

        /* PLOT STYLES */
        .plot-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-top: 30px;
            width: 100%;
        }

        /* container that holds the grid (wrap your grid with this or keep the wrapper you already added) */
        .plot-grid-wrapper {
            width: 80%;           /* you already used this in HTML wrapper; keep or tweak */
            max-width: 1300px;    /* safety cap so plots don't get absurdly wide on huge screens */
            margin: 0 auto;
        }

        .plot-grid-custom4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;

            width: fit-content;    /* shrink to content width */
            margin: 0 auto;        /* center the grid horizontally */
            justify-content: center;
        }

        .plot-grid-custom4 img {
            width: 100%;
            height: auto;
            max-height: 200px;  /* adjust to taste */
            object-fit: contain;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: #000;
            padding: 4px;
        }

        /* Helper to span 2 rows */
        .span-row-2 {
            grid-row: span 2;

            /* IMPORTANT: Override the default max-height
            so the image actually expands to fill both rows */
            height: 100% !important;
            max-height: none !important;
        }

        /* Helper to span the full width (4 columns) */
        .span-full { grid-column: 1 / -1; }

        .plot-grid-custom2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;

            /* THIS Fills gaps automatically */
            grid-auto-flow: dense;

            width: fit-content;    /* shrink to content width */
            margin: 0 auto;        /* center the grid horizontally */
            justify-content: center;
        }

        .plot-grid-custom2 img {
            width: 100%;
            height: auto;
            max-height: 250px;  /* adjust to taste */
            object-fit: contain;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg2-color);
            padding: 4px;
        }

        .plot-grid-2x2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            width: fit-content;      /* shrink to fit content */
            margin: 0 auto;          /* center horizontally */
        }

        .two-row-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .row-with-captions {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 0rem;
        }

.row-with-captions1 {
    display: grid;
    grid-template-columns: 90px 1fr; /* üîë fixed caption, flexible image */
    align-items: center;
    column-gap: 8px;
    height: 120px;                   /* matches image height */
}

.row-with-captions1 img {
    height: 120px;
    width: 100%;
    display: block;
    object-fit: contain;
    background-color: var(--bg2-color);
    border: 2px solid var(--border-color);
}

.material-title {
    margin: 0;
    width: 110px;
    text-align: left;
    white-space: nowrap;
    font-size: 1.7rem;
    padding-right: 14px;   /* üîë THIS fixes _{23} overlap */
    color: var(--highlight2-color);
}

        .caption {
            margin-right: 0.2rem;  /* tiny breathing room */
            margin-left: 0.2rem;
            font-size: 1.1em;
            font-weight: 600;
            width: 20px;             /* adjust to taste */
            text-align: center;
            opacity: 0.8;
        }

        /* Plot boxes: force them to occupy full column width, keep aspect ratio */
        .plot-box {
            width: 100%;
            min-width: 220px;            /* avoids collapsing to a few pixels */
            max-width: 100%;
            max-height: 45vh;   /* adapts to screen */
            aspect-ratio: 16 / 9;        /* preserve your visual format */
            background: var(--bg-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: block;
        }

        .plot-label {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            color: var(--text-color); font-size: 1.4rem; white-space: nowrap; font-weight: bold;
        }

        .plot-hidden {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        .plot-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* TYPOGRAPHY & LAYOUTS */
        h1 { font-size: 3.5rem; margin: 0 0 20px 0; color: var(--text-color); line-height: 1.1; }
        h2 { font-size: 3rem; margin: 0 0 30px 0; color: var(--highlight1-color); font-weight: 400; }
        h3 { font-size: 2.1rem; margin: 0 0 15px 0; color: var(--highlight2-color); }
        p, li { font-size: 1.9rem; color: var(--text-color); line-height: 1.6; }
        span.highlight { color: var(--highlight1-color); }

        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 60px; height: 100%; align-items: center; }
        .three-column { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 60px; height: 100%; align-items: center; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-top: 30px; }
        .tile { background: var(--bg-color); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); }
        .tile i { font-size: 2rem; color: var(--highlight1-color); margin-bottom: 15px; }
        .math-block { background: var(--bg-color); padding: 0px; border-radius: 8px; margin: 0px 0; text-align: center; font-size: 1.7rem; }

        .media-container {
            width: 100%; height: 100%; min-height: 200px;
            background: var(--bg-color); border-radius: 12px; overflow: hidden;
            display: flex; justify-content: center; align-items: center; border: 1px solid var(--border-color);
        }
        .media-container img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .plot-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        .plot-modal.hidden { display: none; }

        .plot-modal-content {
            width: 80vw;
            height: 80vh;
            background: var(--bg-color);
            border-radius: 12px;
            padding: 10px;
        }

        /* Cleaned up Grid for 5 Plots (3 Top, 2 Bottom Centered) */
        .plot-grid-custom3 {
            display: flex;
            flex-wrap: wrap;       /* Allows items to wrap to the next line */
            justify-content: center; /* Centers the items horizontally */
            gap: 18px;             /* Keeps your existing gap */
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .plot-grid-custom3 > .plot-box,
        .plot-grid-custom3 > div,
        .plot-grid-custom3 > img{
            /* MATH: (100% width - 2 gaps of 18px) divided by 3 items */
            width: calc((100% - 36px) / 3);
            height: 300px;

            /* Ensure box-sizing is handled (usually global, but good for safety) */
            box-sizing: border-box;
        }

        .subfigure-row {
            display: flex;
            justify-content: center;
            align-items: stretch; /* Aligns them nicely */
            gap: 0;               /* Images/Videos touch */
            width: 100%;
        }

        /* TARGET BOTH IMG AND VIDEO */
        .subfigure-row img,
        .subfigure-row video {
            height: 160px;        /* Fixed height for all items */
            width: auto;          /* Width adjusts automatically based on aspect ratio */
            object-fit: contain;  /* Prevents cutting off content */
            margin: 0;

            /* Force removal of borders/backgrounds */
            border-radius: 0 !important;
            border: none !important;
            padding: 0 !important;
            background: none !important;

            /* Optional: Ensure video controls don't mess up layout */
            display: block;
        }

        .figure-caption {
            text-align: center;
            font-size: 1.1rem;
            margin-top: 10px;
            opacity: 0.85;
        }

        /* CANVAS */
        .anim-wrapper { position: relative; width: 100%; height: 100%; background: radial-gradient(circle, #222 0%, #000 100%); }
        canvas { display: block; width: 100%; height: 100%; }

        /* CONTROLS */
        .controls-overlay { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; gap: 10px; opacity: 0.3; transition: opacity 0.3s; }
        .controls-overlay:hover { opacity: 1; }
        .nav-btn { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px 15px; border-radius: 6px; cursor: pointer; }
        .nav-plot { cursor: zoom-in; }
        .nav-plot img { width: 100%; height: 100%; object-fit: contain; display: block; pointer-events: none; }

        .progress-bar { position: fixed; bottom: 0; left: 0; height: 4px; background: var(--border-color); width: 0%; transition: width 0.3s; z-index: 101; }

        .slide-footer { position: absolute; bottom: 20px; left: 70px; right: 70px; padding-top: 15px; display: flex; justify-content: space-between; opacity: 0.5; font-size: 0.9rem; }
        .context-controls-overlay {
            position: fixed;
            bottom: 70px;          /* above progress bar */
            right: 20px;           /* or left, your choice */
            display: none;         /* hidden by default */
            z-index: 1000;
        }
        .context-controls-overlay .nav-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
        }
        .back-btn { left: 20px; }
        .skip-btn { right: 20px; }

        .plot-thumb {
            width: 160px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
        }
        .plot-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* Fix flex ‚Üí grid collapse */
        .slide-content { min-width: 0; }

        /* Stabilize Plotly container sizes */
        .plot-box {
            width: 100%;
            min-width: 220px;
            height: 300px;
            background: var(--bg-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: block;
        }

        /* Ensure grid doesn't inherit width: fit-content from other grids */
        .plot-grid-custom3 {
            width: 100% !important;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- CREDIT ROLL SLIDE --- */

        .credit-slide {
            overflow: hidden;
            position: relative;
        }

        /* Viewport that clips the rolling text */
        .credit-viewport {
            position: relative;
            width: 100%;
            height: 70%;
            overflow: hidden;
            margin-top: 20px;
        }

        /* Rolling content */
        .credit-roll {
            position: absolute;
            width: 100%;
            bottom: -100%;
            text-align: center;
            animation: creditScroll 30s linear forwards;
        }

        /* Pause animation unless slide is active */
        .slide:not(.active) .credit-roll {
            animation: none;
        }

        /* Typography */
        .credit-roll h3 {
            margin-top: 40px;
            margin-bottom: 15px;
            font-size: 1.6rem;
            color: var(--highlight2-color);
            font-weight: 500;
        }

        .credit-roll p {
            margin: 6px 0;
            font-size: 1.3rem;
            opacity: 0.9;
        }

        .credit-roll {
            position: absolute;
            width: 100%;
            top: 90%;
            transform: translateY(-50%);
            text-align: center;
            animation: creditScroll 40s linear forwards;
            animation-delay: 0.2s;
            /*animation-timing-function: ease-in-out;*/
        }

        /* Animation */
        @keyframes creditScroll {
            0% {
                transform: translateY(-50%);
            }
            100% {
                transform: translateY(-348%);
            }
        }

        .credit-viewport:hover .credit-roll {
            animation-play-state: paused;
        }

        .credit-viewport::before,
        .credit-viewport::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            height: 60px;
            z-index: 2;
            pointer-events: none;
        }

        .credit-viewport::before {
            top: 0;
            background: linear-gradient(to bottom, #000, transparent);
        }

        .credit-viewport::after {
            bottom: 0;
            background: linear-gradient(to top, #000, transparent);
        }

        #cursor-halo {
            position: fixed;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            pointer-events: none;

            border: 6px solid #8B5DFF;
            box-shadow: 0 0 18px rgba(255,255,255,0.8);

            transform: translate(-50%, -50%);
            opacity: 0;

            z-index: 2147483647; /* beats everything */
        }

        /* CITATIONS */

        .cite {
            font-size: 1.4rem;
            cursor: pointer;
            color: #0059ff;
            margin-left: 3px;
        }

        .cite:hover {
            text-decoration: underline;
        }

        #cite-tooltip {
            position: fixed;
            max-width: 340px;
            background: #ffffff;
            border: 1px solid #333;
            padding: 8px 10px;
            font-size: 1.0rem;
            line-height: 1.3;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.25);
            display: none;
            z-index: 1000;

            color: #000000;   /* ‚Üê THIS IS THE MISSING PIECE */
        }

        /* TABLES */

        .thesis-table {
            border-collapse: collapse;
            margin: 12px auto;
            font-size: 1.4rem;   /* similar to \scriptsize */
            min-width: 420px;
        }

        .thesis-table caption {
            caption-side: bottom;
            font-size: 1.7rem;
            margin-top: 6px;
            color: var(--text-color);
        }

        .thesis-table th,
        .thesis-table td {
            border: 2px solid #bababa;
            padding: 4px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .thesis-table th {
            font-weight: 600;
        }

        .thesis-table .group-header {
            font-weight: 600;
            background: var(--bg-color);
        }

        .table-panel {
            position: relative;      /* relative INSIDE grid slot */
            transform: scale(0.6);
            transform-origin: center;

            background: var(--bg2-color);
            border-radius: 10px;
            padding: 6px;

            font-size: 0.6rem;
            cursor: pointer;

            transition:
                transform 0.25s ease,
                box-shadow 0.25s ease;
        }

        .plot-box.table-slot {
            overflow: visible;       /* üîë allow expansion */
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg2-color);
        }

        /* compact table style */
        .thesis-table.compact th,
        .thesis-table.compact td {
            padding: 3px 6px;
        }

        .table-panel.expanded {
            position: fixed;

            top: 8%;
            bottom: 8%;
            left: 8%;
            right: 8%;

            transform: scale(1);
            font-size: 0.95rem;

            z-index: 3000;
            box-shadow: 0 0 30px var(--shadow-color);
            background: var(--bg2-color);

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .XANES {height: 120px; width: 90px; background-color: var(--bg2-color); border: 2px solid var(--border-color);}

        /* Turns white-background plots into dark-mode plots */
        .img-dark-mode1,
        .img-dark-mode2 {
            /* invert(0.9) = Dark Grey background (softer than black)
            hue-rotate(180deg) = Fixes colors (Blue stays Blue)
            saturate(2) = A moderate boost to make colors visible on grey */
            filter: invert(0.85) hue-rotate(180deg) saturate(4) contrast(1.2);
        }

        /* --- Special Fix for Zoomed Dark Mode Images --- */
        /* Target the modal image ID + the dark mode class */
        #mediaZoomImg.img-dark-mode1,
        #imgZoomModalImg.img-dark-mode1 {
            /* 1. invert(1) hue-rotate(180deg): Standard inversion.
            2. saturate(5): Extreme saturation to force color back into the white lines.
            3. brightness(0.7): THE KEY FIX. Dims the "Neon White" down to "Deep Blue".
            4. contrast(1.5): Ensures the background stays pitch black.
            */
            filter: invert(0.88) hue-rotate(180deg) saturate(6) brightness(0.7) contrast(1.6);
        }
        #mediaZoomImg.img-dark-mode2,
        #imgZoomModalImg.img-dark-mode2 {
            /* 1. invert(1) hue-rotate(180deg): Standard inversion.
            2. saturate(5): Extreme saturation to force color back into the white lines.
            3. brightness(0.7): THE KEY FIX. Dims the "Neon White" down to "Deep Blue".
            4. contrast(1.5): Ensures the background stays pitch black.
            */
            filter: invert(0.88) hue-rotate(180deg) saturate(6) brightness(0.8) contrast(1.6);
        }

        /* -----------------------------------------
        MATERIALS SLIDE
        ----------------------------------------- */
        .material-block {
            background: var(--bg2-color);
            border-radius: 10px;

            /* smaller padding than conclusions */
            padding: 8px 8px;

            /* lighter shadow */
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
            /* appear animation */
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.3s ease, transform 0.3s ease;

            /* keep original sizing behavior */
            font-size: 1.4rem;
            line-height: 1.25;
        }
        .material-block.active {
            opacity: 1;
        }
        .material-block.dimmed {
            opacity: 0.5;
        }

        .material-block ul li {
            position: relative;
            margin: 0.3rem 0;
            cursor: pointer;
        }

        /* Only JS popups now */
        .material-popup {
            position: absolute;
            background-color: var(--bg2-color);
            color: #fff;
            padding: 0.5rem 0.8rem;
            border-radius: 5px;
            font-size: 1.7rem;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .material-popup.show {
            opacity: 1;
        }
        /* -----------------------------------------
        CONCLUSIONS SLIDE
        ----------------------------------------- */

        .conclusions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .conclusion-block {
            background: var(--bg2-color);
            border-radius: 14px;
            padding: 18px 22px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);

            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.35s ease, transform 0.35s ease;
        }

        .conclusion-block.active {
            opacity: 1;
            transform: translateY(0);
        }

        .conclusion-block h3 {
            margin-bottom: 10px;
            color: var(--highlight2-color);
            font-size: 1.6rem;
        }

        .conclusion-block ul {
            margin: 0;
            padding-left: 1.2em;
        }

        .conclusion-block li {
            margin-bottom: 6px;
            font-size: 1.4rem;
            line-height: 1.25;
        }

        /* Overlay PLOTS*/
        .overlay-plot-container {
            position: relative;
            width: 520px;      /* match your plot size */
            height: auto;
            margin: 0 auto;
        }

        .plot {
            width: 100%;
            display: block;
        }

        .reference {
            position: relative;
            z-index: 1;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;

            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .overlay.active {
            opacity: 1.0; /* key for comparison */
        }

        /* Buttons container */
        .overlay-controls {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        /* Base button */
        .overlay-controls button {
            background: var(--bg2-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);

            padding: 10px 22px;
            font-size: 1.6rem;
            font-weight: 500;

            border-radius: 10px;
            cursor: pointer;

            min-width: 120px;
            text-align: center;

            position: relative;      /* üîë */
            z-index: 2;              /* üîë */

            transition:
                box-shadow 0.18s ease,
                background 0.18s ease,
                border-color 0.18s ease,
                padding 0.18s ease;
        }

        /* Hover */
        .overlay-controls button:hover {
            box-shadow: 0 6px 14px rgba(0,0,0,0.35);
        }

        /* Active overlay button ‚Äî NO TRANSFORM */
        .overlay-controls button.active {
            background: var(--bg2-color);
            color: var(--highlight2-color);
            border-color: var(--border-color);
            font-size: 1.6rem;

            /* Visual emphasis WITHOUT layout break */
            padding: 12px 26px;
            box-shadow:
                0 0 0 3px rgba(255,255,255,0.25),
                0 10px 22px rgba(0,0,0,0.45);
        }

        /* Prevent focus outline weirdness */
        .overlay-controls button:focus {
            outline: none;
        }

        /* KS / GW mode containers */
        .mode-container {
            display: none;
        }

        .mode-container.active {
            display: block;
        }

        /* Mode buttons */
        .overlay-mode-controls {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .mode-btn {
            background: var(--bg2-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 20px;
            font-size: 1.9rem;
            border-radius: 10px;
            cursor: pointer;
        }

        .mode-btn.active {
            background: var(--bg2-color);
            color: #4cd964;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.25);
        }
        /* Active overlay button ‚Äî mode dependent text color */

        /* KS mode */
        .slide[data-mode="KS"] .overlay-controls button.active {
            color: #4da6ff;
        }

        /* GW mode */
        .slide[data-mode="GW"] .overlay-controls button.active {
            color: #ff6b6b;
        }

        /* Rows inside overlay controls */
        .overlay-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 6px 0;
        }

        /* Row labels */
        .overlay-row-label {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--highlight2-color);
            margin-right: 8px;
            white-space: nowrap;
        }

        /* Play button */
        .video-play-btn {
            position: absolute;
            top: 18px;
            right: 24px;
            font-size: 28px;
            background: none;
            border: none;
            color: var(--accent-color, white);
            cursor: pointer;
            z-index: 10;
        }

        .video-play-btn:hover {
            transform: scale(1.15);
        }

        /* Overlay */
        .video-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .video-overlay.hidden {
            display: none;
        }

        /* Video box */
        .video-container {
            width: 70%;
            max-width: 960px;
        }

        .video-container video {
            width: 100%;
            height: auto;
            border: 2px solid var(--border-color);
            background: black;
        }

        /* -----------------------------------------
        REFERENCES SCROLL ‚Äî TRUE CONTINUOUS LOOP
        ----------------------------------------- */

        .citations-slide .credit-viewport {
            position: relative;
            height: 70%;
            overflow: hidden;
        }

        /* Shared lane style */
        .citations-slide .credit-lane {
            position: absolute;
            width: 60%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Typography */
        .citations-slide p {
            font-size: 1.8rem;
            line-height: 1.35;
            margin: 0.8em 0;
            text-align: justify;
        }

    </style>
</head>
<body>

<div id="presentation-container">

    <!-- SLIDE 1: THE COMPLEX TITLE SCENE -->
    <div class="slide active" id="slide1">
        <div class="slide-content">

            <!-- LAYER A: The Title -->
            <div class="slide-layer" id="layer-title">
                <div style="text-align: center;">
                    <h1 style="font-size: 3rem; line-height: 1.4;">
                        <span class="step-text" id="step-0">Determinaci√≥n</span> de los<br>
                        <span class="step-text" id="step-1">espectros de absorci√≥n √≥ptica y de rayos X</span><br>
                        en <span class="step-text" id="step-5">semiconductores y aislantes</span><br>
                        mediante un tratamiento <span class="step-text" id="step-7">ab initio</span><br>
                        <span class="step-text" id="step-8">all-electron incluyendo efectos de muchos cuerpos</span>
                    </h1>

                    <div style="margin-top: 60px; border-top: 2px solid #41B3FF; padding-top: 30px; display: inline-block;">
                        <p style="font-size: 1.8rem; color: #fff; margin: 0;">Jer√≥nimo No√© Acito Pino</p>
                        <p style="font-size: 1.5rem; color: #fff; margin: 0;">Directora - Dra Gabriela Grad</p>
                        <p style="font-size: 1.5rem; opacity: 0.7; margin: 10px 0 0 0;">Universidad Nacional de C√≥rdoba | FAMAF</p>
                    </div>
                </div>
            </div>

            <!-- LAYER B: The Plot Workflow -->
            <div class="slide-layer hidden" id="layer-workflow">
                <!-- EXPERIMENTAL CANVAS -->
                <div style="width: 100%; height: 200px; margin-bottom: 30px; position: relative; border-bottom: 1px solid var(--border-dim);">
                    <canvas id="experimentCanvas"></canvas>
                </div>

                <!-- PLOTS ROW -->
                <div class="plot-container">
                    <div id="plot-group-1" class="plot-hidden" style="position: relative;">
                        <div class="plot-label">Incidencia</div>
                        <div id="plot-1" style="width: 300px; height: 220px;"></div>

                        <script>
                        fetch("incident.dat")
                        .then(r => r.text())
                        .then(text => {

                            const rows = text
                            .split("\n")
                            .filter(r => r.trim() && !r.trim().startsWith("#"));

                            const k = [];
                            const v1 = [];
                            const y_eps = Number(0.2);

                            rows.forEach(r => {
                            const cols = r.trim().split(/\s+/);
                            const x  = Number(cols[0]);
                            const y1 = Number(cols[1]);

                            if (!isNaN(x) && !isNaN(y1)) {
                                k.push(x);
                                v1.push(y1);
                            }
                            });

                            const traces = [{
                            x: k,
                            y: v1,
                            mode: "lines",
                            name: "Incidente",
                            line: { width: 2, color: PALETTE.curve1 }
                            }];

                            const layout = {
                            width: 300,
                            height: 220,
                            margin: { l: 40, r: 20, t: 10, b: 40 },

                            paper_bgcolor: "#111",
                            plot_bgcolor: "#111",
                            font: { color: PALETTE.text },

                            xaxis: {
                                title: "Energ√≠a",
                                showgrid: false,
                                zeroline: false,
                                showticklabels: false,
                                range: [-0.05, Math.max(...k)]   // ‚úÖ only positive x
                            },

                            yaxis: {
                                title: "Intensidad",
                                showgrid: false,
                                zeroline: false,
                                showticklabels: false,
                                range: [-0.05, Math.max(...v1) + y_eps]  // ‚úÖ only positive y
                            },

                            // ‚úÖ MANUAL AXES WITH ARROWS
                            shapes: [
                                // X-axis with arrow
                                {
                                type: "line",
                                x0: 0, y0: 0,
                                x1: Math.max(...k), y1: 0,
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: Math.max(...k), y0: 0,
                                x1: Math.max(...k) - 0.05*Math.max(...k), y1: 0.02*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: Math.max(...k), y0: 0,
                                x1: Math.max(...k) - 0.05*Math.max(...k), y1: -0.02*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },

                                // Y-axis with arrow
                                {
                                type: "line",
                                x0: 0, y0: 0,
                                x1: 0, y1: Math.max(...v1) + y_eps,
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: 0, y0: Math.max(...v1) + y_eps,
                                x1: 0.02*Math.max(...k), y1: Math.max(...v1) + y_eps - 0.05*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: 0, y0: Math.max(...v1) + y_eps,
                                x1: -0.02*Math.max(...k), y1: Math.max(...v1) + y_eps - 0.05*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                }
                            ]
                            };


                            const config = {
                            displayModeBar: false,   // ‚úÖ Removes toolbar
                            responsive: false
                            };

                            Plotly.newPlot("plot-1", traces, layout, config);
                        });
                        </script>

                    </div>
                    <i id="arrow-1" class="fa-solid fa-arrow-right plot-hidden" style="font-size: 2rem; color: var(--arrow-color);"></i>
                    <div id="plot-group-2" class="plot-hidden" style="position: relative;">
                        <div class="plot-label">Transmisi√≥n</div>
                        <div id="plot-2" style="width: 300px; height: 220px;"></div>

                        <script>
                        fetch("transmited.dat")
                        .then(r => r.text())
                        .then(text => {

                            const rows = text
                            .split("\n")
                            .filter(r => r.trim() && !r.trim().startsWith("#"));

                            const k = [];
                            const v1 = [];
                            const y_eps = Number(0.2);

                            rows.forEach(r => {
                            const cols = r.trim().split(/\s+/);
                            const x  = Number(cols[0]);
                            const y1 = Number(cols[1]);

                            if (!isNaN(x) && !isNaN(y1)) {
                                k.push(x);
                                v1.push(y1);
                            }
                            });

                            const traces = [{
                            x: k,
                            y: v1,
                            mode: "lines",
                            name: "Transmisi√≥n",
                            line: { width: 2, color: PALETTE.curve1 }
                            }];

                            const layout = {
                            width: 300,
                            height: 220,
                            margin: { l: 40, r: 20, t: 10, b: 40 },

                            paper_bgcolor: "#111",
                            plot_bgcolor: "#111",
                            font: { color: PALETTE.text },

                            xaxis: {
                                title: "Energ√≠a",
                                showgrid: false,
                                zeroline: false,
                                showticklabels: false,
                                range: [-0.05, Math.max(...k)]   // ‚úÖ only positive x
                            },

                            yaxis: {
                                title: "Intensidad",
                                showgrid: false,
                                zeroline: false,
                                showticklabels: false,
                                range: [-0.05, Math.max(...v1) + y_eps]  // ‚úÖ only positive y
                            },

                            // ‚úÖ MANUAL AXES WITH ARROWS
                            shapes: [
                                // X-axis with arrow
                                {
                                type: "line",
                                x0: 0, y0: 0,
                                x1: Math.max(...k), y1: 0,
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: Math.max(...k), y0: 0,
                                x1: Math.max(...k) - 0.05*Math.max(...k), y1: 0.02*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: Math.max(...k), y0: 0,
                                x1: Math.max(...k) - 0.05*Math.max(...k), y1: -0.02*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },

                                // Y-axis with arrow
                                {
                                type: "line",
                                x0: 0, y0: 0,
                                x1: 0, y1: Math.max(...v1) + y_eps,
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: 0, y0: Math.max(...v1) + y_eps,
                                x1: 0.02*Math.max(...k), y1: Math.max(...v1) + y_eps - 0.05*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: 0, y0: Math.max(...v1) + y_eps,
                                x1: -0.02*Math.max(...k), y1: Math.max(...v1) + y_eps - 0.05*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                }
                            ]
                            };


                            const config = {
                            displayModeBar: false,   // ‚úÖ Removes toolbar
                            responsive: false
                            };

                            Plotly.newPlot("plot-2", traces, layout, config);
                        });
                        </script>
                    </div>
                    <i id="arrow-2" class="fa-solid fa-arrow-right plot-hidden" style="font-size: 2rem; color: var(--arrow-color);"></i>
                    <div id="plot-group-3" class="plot-hidden" style="position: relative;">
                        <div class="plot-label"><span style="color: var(--highlight1-color)">Absorci√≥n</span></div>
                        <div id="plot-3" style="width: 300px; height: 220px;"></div>

                        <script>
                        fetch("absorbed.dat")
                        .then(r => r.text())
                        .then(text => {

                            const rows = text
                            .split("\n")
                            .filter(r => r.trim() && !r.trim().startsWith("#"));

                            const k = [];
                            const v1 = [];
                            const y_eps = Number(0.2);

                            rows.forEach(r => {
                            const cols = r.trim().split(/\s+/);
                            const x  = Number(cols[0]);
                            const y1 = Number(cols[1]);

                            if (!isNaN(x) && !isNaN(y1)) {
                                k.push(x);
                                v1.push(y1);
                            }
                            });

                            const traces = [{
                            x: k,
                            y: v1,
                            mode: "lines",
                            name: "Absorci√≥n",
                            line: { width: 2, color: PALETTE.curve1 }
                            }];

                            const layout = {
                            width: 300,
                            height: 220,
                            margin: { l: 40, r: 20, t: 10, b: 40 },

                            paper_bgcolor: "#111",
                            plot_bgcolor: "#111",
                            font: { color: PALETTE.text },

                            xaxis: {
                                title: "Energ√≠a",
                                showgrid: false,
                                zeroline: false,
                                showticklabels: false,
                                range: [-0.05, Math.max(...k)]   // ‚úÖ only positive x
                            },

                            yaxis: {
                                title: "Intensidad",
                                showgrid: false,
                                zeroline: false,
                                showticklabels: false,
                                range: [-0.05, Math.max(...v1) + y_eps]  // ‚úÖ only positive y
                            },

                            // ‚úÖ MANUAL AXES WITH ARROWS
                            shapes: [
                                // X-axis with arrow
                                {
                                type: "line",
                                x0: 0, y0: 0,
                                x1: Math.max(...k), y1: 0,
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: Math.max(...k), y0: 0,
                                x1: Math.max(...k) - 0.05*Math.max(...k), y1: 0.02*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: Math.max(...k), y0: 0,
                                x1: Math.max(...k) - 0.05*Math.max(...k), y1: -0.02*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },

                                // Y-axis with arrow
                                {
                                type: "line",
                                x0: 0, y0: 0,
                                x1: 0, y1: Math.max(...v1) + y_eps,
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: 0, y0: Math.max(...v1) + y_eps,
                                x1: 0.02*Math.max(...k), y1: Math.max(...v1) + y_eps - 0.05*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                },
                                {
                                type: "line",
                                x0: 0, y0: Math.max(...v1) + y_eps,
                                x1: -0.02*Math.max(...k), y1: Math.max(...v1) + y_eps - 0.05*Math.max(...v1),
                                line: { color: "white", width: 2 }
                                }
                            ]
                            };


                            const config = {
                            displayModeBar: false,   // ‚úÖ Removes toolbar
                            responsive: false
                            };

                            Plotly.newPlot("plot-3", traces, layout, config);
                        });
                        </script>
                    </div>
                </div>
            </div>

            <!-- LAYER C: Static Band Diagram (New) -->
            <div class="slide-layer hidden" id="layer-static-bands">
                <h2>Estructura de Bandas <span class="highlight">Esquem√°tica</span></h2>
                <div class="media-container" style="background: var(--bg-color); border: 1px solid var(--border-color); width: 80%; height: 60%;">
                    <canvas id="staticBandsCanvas"></canvas>
                </div>
                <p style="margin-top: 20px;">Representaci√≥n del Gap Directo.</p>
            </div>

        </div>
    </div>

    <!-- SLIDE 2: Theoretical Framework -->
    <div class="slide" data-ignore >
        <div class="slide-content">
            <h2 style="color: var(--highlight1-color)">Marco Te√≥rico</h2>
            <div class="grid-3">
                <div class="tile">
                    <i class="fa-solid fa-cube"></i>
                    <h3>1. DFT</h3>
                    <p>Resuelve las ecuaciones de Kohn-Sham para obtener funciones de onda (\(\phi\)) y energ√≠as (\(E^{KS}\)).</p>
                </div>
                <div class="tile">
                    <i class="fa-solid fa-atom"></i>
                    <h3>2. Aprox. GW</h3>
                    <p>Calcula energ√≠as de Cuasipart√≠cula (\(E^{QP}\)). Corrige el gap de banda mediante la autoenerg√≠a.</p>
                </div>
                <div class="tile">
                    <i class="fa-solid fa-bolt"></i>
                    <h3>3. BSE</h3>
                    <p>Resuelve la Ecuaci√≥n de Bethe-Salpeter para la funci√≥n de Green de dos part√≠culas (e-h).</p>
                </div>
            </div>
            <div class="slide-footer"><span></span><span>2 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 3: DFT - Intro -->
    <div class="slide" data-ignore id="slide-DFT-intro1">
        <div class="slide-content">
            <h2>DFT: Teor√≠a del Funcional de la Densidad </span></h2>
            <div class="two-column">
                <div>
                    <ul>
                        <li><strong style="color: var(--highlight2-color)">Reformula el problema</strong> de muchos cuerpos en t√©rminos de la densidad electr√≥nica œÅ(r).</li>
                        <li><strong style="color: var(--highlight2-color)">Reduce el n√∫mero de variables</strong> necesarias.</li>
                        <li>Resoluci√≥n mediante la <strong style="color: var(--highlight2-color)">minimizaci√≥n de la funcional energ√≠a.</strong></li>
                    </ul>
                </div>

                <!-- ANIMATED CANVAS REPLACING SVG -->
                <div class="media-container" style="background: var(--bg-color); border: 1px solid var(--border-color); height:75%;">
                    <canvas id="mbDftCanvas"></canvas>
                </div>


            </div>
            <div class="slide-footer"><span></span><span>3 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 4: DFT - intro2 -->
    <div class="slide" data-ignore id="slide-DFT-intro2">
        <div class="slide-content">
            <h2>DFT: Teor√≠a del Funcional de la Densidad </span></h2>
            <div class="two-column">
                <div>
                    <ul>
                        <li><strong style="color: var(--highlight2-color)">Las ecuaciones de Kohn-Sham</strong> mapean el problema a un sistema efectivo de part√≠culas <strong style="color: var(--highlight2-color)">independientes</strong>.
                        <div class="math-block">
                        $$ \left\{ -\frac{\hbar^2\nabla^2}{2m} + v_{H}[n] + v_{ext} + v_{XC}[n]\right\}\phi_i(\textbf{r}\sigma) = \epsilon_i\phi_i(\textbf{r}\sigma)$$
                        </div></li>
                        <li><strong style="color: var(--highlight2-color)">Remueve </strong> las interacciones expl√≠citas.</li>
                        <li><strong style="color: var(--highlight2-color)">Debe aproximarse</strong> el potencial de correlaci√≥n intercambio \(v_{xc}\).</li>
                    </ul>
                </div>

                <!-- ANIMATED CANVAS REPLACING SVG -->
                <div class="media-container" style="background: var(--bg-color); border: 1px solid var(--border-color); height: 80%;">
                    <canvas id="KSCanvas"></canvas>
                </div>


            </div>
            <div class="slide-footer"><span></span><span>4 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 5: DFT - Pros -->
    <div class="slide" data-ignore id="slide-DFT-pros">
        <div class="slide-content">
            <h2>DFT: Teor√≠a del Funcional de la Densidad </span></h2>
            <div class="two-column">
                <div>
                    <p><strong>Pros:</strong></p>
                    <ul>
                        <li><strong style="color: var(--highlight2-color)">Costo computacional moderado.</strong></li>
                        <li>Excelente descripci√≥n del <strong style="color: var(--highlight2-color)">estado fundamental.</strong></li>
                        <li>Base de <strong style="color: var(--highlight2-color)"> los m√©todos ab initio modernos.</strong></li>
                    </ul>
                </div>

                <!-- Humorous Illustration -->
                <div class="media-container" style="height: 57%; width: 78%; background: var(--bg-color); border: 1px solid var(--border-color);">
                    <img src="XC_illustration.png" alt="DFT Diagram">
                </div>

            </div>
            <div class="slide-footer"><span></span><span>5 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 6: DFT - Cons -->
    <div class="slide" data-ignore id="slide-DFT-cons">
        <div class="slide-content">
            <h2>DFT: Limitaciones</h2>

            <div class="two-column">
                <div>
                    <p><strong>Contras:</strong></p>
                    <ul>
                        <li><strong style="color: var(--highlight2-color)">Subestima sistem√°ticamente el gap</strong> con funcionales est√°ndar (LDA).</li>
                        <li>No describe correctamente <strong style="color: var(--highlight2-color)">estados excitados</strong>.</li>
                    </ul>

                    <p style="margin-top:1rem; opacity:0.85;">
                        Esta limitaci√≥n motiva el uso de <strong style="color: var(--highlight1-color)">GW</strong> para cuasipart√≠culas y <strong style="color: var(--highlight1-color)">BSE</strong> para excitaciones √≥pticas.
                    </p>
                </div>

                <!-- BAND GAP UNDERESTIMATION IMAGE -->
                <div class="media-container" style="background: var(--bg-color); border: 1px solid var(--border-color); height:50%;">
                    <canvas id="bandgapCanvas" width="900" height="300"></canvas>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>6 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 7: GW - Intro -->
    <div class="slide" data-ignore id="slide-GW-green">
        <div class="slide-content">
            <h2>Aprox. GW: Idea Funci√≥n de Green G</h2>

            <div class="two-column">
                <p>Se introduce la <strong style="color: var(--highlight2-color)">funci√≥n de Green (G)</strong> para describir la propagaci√≥n de un electr√≥n o hueco.</p>

                <div class="two-column">
                   <!-- ELECTRON PROPAGATION -->
                    <div style="text-align: center; display: flex; flex-direction: column; height: auto;">
                        <h3 style="color: var(--highlight2-color); text-align:center;">Propagaci√≥n de Electr√≥n (G<sup>&gt;</sup>)</h3>
                        <div class="media-container">
                            <div class="anim-wrapper" >
                                <canvas id="greenElectronCanvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- HOLE PROPAGATION -->
                    <div style="text-align: center; display: flex; flex-direction: column; height: auto;">
                        <h3 style="color: var(--highlight2-color); text-align:center;">Propagaci√≥n de Hueco (G<sup>&lt;</sup>)</h3>
                        <div class="media-container">
                            <div class="anim-wrapper">
                                <canvas id="greenHoleCanvas"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="slide-footer"><span></span><span>7 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 8: GW - Intro -->
    <div class="slide" data-ignore id="slide-GW-intro">
        <div class="slide-content">
            <h2>Aprox. GW: interacci√≥n Coulomb apantallada W</h2>

            <div class="two-column">
                <div>
                    <ul>
                        <li>Se introduce una <strong style="color: var(--highlight2-color)">apantallamiento (W)</strong> por la <strong style="color: var(--highlight2-color)">polarizaci√≥n del medio (\(\Pi\))</strong>.</li>
                        <li>La part√≠cula real se describe como una <strong style="color: var(--highlight1-color)">cuasipart√≠cula</strong>:
                        <strong style="color: var(--highlight2-color)">electr√≥n/hueco</strong> + <strong style="color: var(--highlight2-color)">respuesta del medio</strong>.</li>
                    </ul>

                </div>

                <!-- INTERACTIVE SCREENING DEMO -->
                <div style="text-align: center; display: flex; flex-direction: column; height: auto;">
                    <h3 style="color: var(--accent-purple); text-align:center;">Extra electr√≥n (repulsi√≥n)</h3>
                    <div class="media-container" style="flex: 1;  max-height: 300px;">
                        <div style="position: absolute; top: 10px; left: 10px; color: var(--text-secondary); font-size: 14px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px;"></div>
                        <canvas id="screenElectronCanvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="slide-footer"><span></span><span>8 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 9: GW - Teor√≠a -->
    <div class="slide" data-ignore id="slide-GW-theory">
        <div class="slide-content">
            <h2>Aprox. GW: correci√≥n de cuasipart√≠culas</h2>

            <div class="two-column">
                <div>
                    <p><strong>Pros:</strong></p>
                    <ul>
                        <li>GW surge como la <strong style="color: var(--highlight2-color)">aproximaci√≥n m√°s baja</strong> de las ecuaciones de Hedin.</li>
                        <li>Se corrigen las energ√≠as con la <strong style="color: var(--highlight2-color)">autoenerg√≠a Œ£</strong>.
                        <div class="math-block">
                        $$
                        E^{\mathrm{QP}} = E^{KS} + Z \left[  \mathrm{Re}\{\Sigma(E)\} - V^{\mathrm{XC}}
                        \right]
                        $$
                        </div></li>
                        <li><strong style="color: var(--highlight2-color)">Corrige el gap electr√≥nico</strong> por interacciones de muchos cuerpos.</li>
                    </ul>

                </div>

                <!-- Humorous Illustration -->
                <div class="media-container" style="height: 56%; width: 78%; background: var(--bg-color); border: 1px solid var(--border-color);">
                    <img src="First_order_illustration.jpg" alt="GW Diagram">
                </div>
            </div>

            <div class="slide-footer"><span></span><span>9 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 10: GW - Contras -->
    <div class="slide" data-ignore id="slide-GW-cons">
        <div class="slide-content">
            <h2>Aprox. GW: Limitaciones</h2>

            <div>
                <p><strong>Contras:</strong></p>
                <ul>
                    <li>Los espectros calculados corresponden a <strong style="color: var(--highlight2-color)">cuasipart√≠culas independientes</strong>.</li>
                    <li><strong style="color: var(--highlight2-color)">No describe excitaciones neutras</strong> (no hay electr√≥n-hueco ligado).</li>
                    <li>El c√°lculo <strong style="color: var(--highlight2-color)">single-shot</strong> depende del punto de partida del estado fundamental.</li>
                </ul>

                <p style="margin-top:1rem; opacity:0.85;">
                    Para describir <strong style="color: var(--highlight1-color)">excitones</strong> y absorci√≥n √≥ptica es necesario resolver la
                    <strong style="color: var(--highlight1-color)">ecuaci√≥n de Bethe-Salpeter (BSE)</strong>.
                </p>
            </div>

            <div class="slide-footer"><span></span><span>10 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 11: BSE - Intro -->
    <div class="slide" data-ignore id="slide-BSE-intro">
        <div class="slide-content">
            <h2>BSE: La Ecuaci√≥n de <span class="highlight">Bethe-Salpeter</span></h2>
            <div class="two-column" style="grid-template-columns: 40% 60%;">
                <div>
                    <p>Para describir excitaciones neutras, debemos tratar el electr√≥n y el hueco como un par acoplado. Se resuelve un sistema efectivo con:</p>

                    <ul>
                        <li>\(H^{\mathrm{diag}}\) - part√≠culas independientes.</li>
                        <li>\(H^c\) - correlaci√≥n (atractivo).</li>
                        <li>\(H^x\) - intercambio (repulsivo).</li>
                    </ul>
                    <div class="math-block">
                        $$
                        H^{\mathrm{eff}} A^{\lambda} = E^{\lambda} A^{\lambda}, \\
                        $$
                        $$
                        H^{\mathrm{eff}} = H^{\mathrm{diag}} + \gamma_c H^c + 2\gamma_x H^x
                        $$
                    </div>
                </div>
                <div class="media-container" onclick="resetAnim()"  style="max-height: 350px;max-width: 700px;">
                    <div class="anim-wrapper">
                        <canvas id="excitationCanvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="slide-footer"><span></span><span>11 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 12: BSE - Intro -->
    <div class="slide" data-ignore id="slide-excitons-type">
        <div class="slide-content">
            <h2>BSE: tipos de excitones</h2>

            <div class="three-column">

                <div style="text-align: center; display: flex; flex-direction: column; height: auto;">
                        <img src="E_binding.png" alt="Binding Energy Plot" style="height: auto; object-fit: contain; max-height: 300px; border-radius: 12px; border: 1px solid var(--border-color)">
                        <p>\( E_b = E_{gap} - E_{exc}\)</p>
                </div>

                <div style="text-align: center; display: flex; flex-direction: column; height: auto;">
                        <h3 style="color: var(--highlight2-color); text-align:center;">Frenkel</h3>
                        <div class="media-container" style="margin: 0 auto;">
                            <canvas id="frenkelCanvas"></canvas>
                        </div>
                        <p>Fuertemente ligado <br> Localizado <br> \( E_b \sim 1eV\)</p>
                </div>

                <div style="text-align: center; display: flex; flex-direction: column; height: auto;">
                    <h3 style="color: var(--highlight2-color); text-align:center;">Wannier-Mott</h3>
                    <div class="media-container" style="margin: 0 auto;">
                            <canvas id="wannierCanvas"></canvas>
                    </div>
                    <p>D√©bilmente ligado <br> Deslocalizado <br> \( E_b \sim 0.1eV\)</p>
                </div>

            </div>
            <div class="slide-footer"><span></span><span>12 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 13: Materials Applications -->
    <div class="slide" data-ignore id="slide-materials">
        <div class="slide-content">
            <h2>Materiales: Aplicaciones</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: fit-content; margin: 0 auto; ">

                <!-- Row 1 -->
                <div id="mat-LiF" class="material-block">
                    <div class="caption caption-left" style="color:var(--highlight2-color);font-size: 1.9rem; text-align: right;">LiF</div>
                    <ul>
                        <li data-popup="Gracias a su amplio rango de transparencia, se usa en sistemas l√°ser excimer y √≥ptica ultravioleta.">√ìptica UV y sistemas l√°ser excimer</li>
                        <li data-popup="Material resistente a radiaci√≥n y con alto contenido de Li, ideal para detectores de neutrones y dos√≠metros.">Detecci√≥n de neutrones</li>
                        <li data-popup="Cristales LiF:Mg,Ti se usan ampliamente para dosimetr√≠a termoluminiscente en radiolog√≠a y f√≠sica de radiaci√≥n.">Dosimetr√≠a (ej. LiF:Mg,Ti)</li>
                    </ul>
                </div>

                <div id="mat-MgO" class="material-block">
                    <div class="caption caption-right" style="color:var(--highlight2-color);font-size: 1.9rem; text-align: left;">MgO</div>
                    <ul>
                        <li data-popup="Amplio uso como material refractario y alta resistencia t√©rmica en aceros y hornos.">Material refractario</li>
                        <li data-popup="Mejora la actividad y la resistencia al envenenamiento por coque.">Soporte de catalizadores y aditivos</li>
                        <li>Adsorbente ambiental</li>
                    </ul>
                </div>

                <!-- Row 2 -->
                <div id="mat-CaO" class="material-block">
                    <div class="caption caption-left" style="color:var(--highlight2-color);font-size: 1.9rem;">CaO</div>
                    <ul>
                        <li>Producci√≥n de acero y cemento</li>
                        <li data-popup="Captura de CO‚ÇÇ y neutralizaci√≥n de √°cidos.">Tecnolog√≠as ambientales</li>
                        <li data-popup="Regulaci√≥n de acidez en productos industriales y alimentarios.">Aditivo alimentario</li>
                    </ul>
                </div>

                <div id="mat-ZnO" class="material-block">
                    <div class="caption caption-right" style="color:var(--highlight2-color);font-size: 1.9rem;">ZnO</div>
                    <ul>
                        <li>Optoelectr√≥nica</li>
                        <li>LEDs UV, diodos y l√°seres</li>
                        <li>Biomedicina</li>
                    </ul>
                </div>

            </div>

            <div class="slide-footer"><span></span><span>13 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 14: Materials structure -->
    <div class="slide" data-ignore id="slide-materials-structure">
        <div class="slide-content">
            <h2>Estructura Cristalina</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
            <div class="plot-grid-custom4">
                    <h3>LiF: sal de roca</h3>
                    <h3>MgO: sal de roca</h3>
                    <h3>CaO: sal de roca</h3>
                    <h3>ZnO: wurtzita hexagonal</h3>
                    <img src="LiF/LiF_structure.png" alt="Struct_LiF">
                    <img src="MgO/MgO_structure.png" alt="Struct_MgO">
                    <img src="CaO/CaO_structure.png" alt="Struct_CaO">
                    <img src="ZnO/ZnO_structure.png" alt="Struct_ZnO">
                    <div class="plot-box table-slot span-full" style="height: 250px; width:30%; margin: auto;">
                        <div class="table-panel">
                        <table class="thesis-table compact">
                        <caption>
                            Par√°metros de red calculados, comparados con los experimentales <span class="cite" data-cite="lattice_constants"></span>.
                        </caption>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>a [√Ö] (KS)</th>
                                <th>c/a (KS)</th>
                                <th>a [√Ö] (Exp.)</th>
                                <th>c/a (Exp.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>  <td>LiF</td>  <td>4.006</td>  <td>1</td>      <td>3.960</td>  <td>1</td>      </tr>
                            <tr>  <td>MgO</td>  <td>4.218</td>  <td>1</td>      <td>4.186</td>  <td>1</td>      </tr>
                            <tr>  <td>CaO</td>  <td>4.768</td>  <td>1</td>      <td>4.787</td>  <td>1</td>      </tr>
                            <tr>  <td>ZnO</td>  <td>3.233</td>  <td>5.220</td>  <td>3.275</td>  <td>5.247</td>  </tr>
                        </tbody>
                        </table>
                        </div>
                    </div>
            </div>
            </div>


            <div class="slide-footer"><span></span><span>14 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 15: Electronic Structure -->
    <div class="slide" data-ignore id="slide-electStruct" data-show-skip="true" data-skip-target="slide-groundstate-tables">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: Bandas y DOS</h2>

        <div class="two-row-wrapper">

            <!-- Row 1 -->
            <div class="row-with-captions">
                <div class="caption caption-left" style="color:var(--highlight2-color);font-size: 1.9rem;">LiF</div>

                <div class="plot-grid-custom2">
                    <img src="LiF/PROJECTED/bands-dos.png" class="nav-plot" alt="electStruct_LiF" data-target-slide="slide-projections-LiF">
                    <img src="MgO/PROJECTED/bands-dos.png" class="nav-plot" alt="electStruct_MgO" data-target-slide="slide-projections-MgO">
                </div>

                <div class="caption caption-right" style="color:var(--highlight2-color);font-size: 1.9rem;">MgO</div>
            </div>

            <!-- Row 2 -->
            <div class="row-with-captions">
                <div class="caption caption-left" style="color:var(--highlight2-color);font-size: 1.9rem;">CaO</div>

                <div class="plot-grid-custom2">
                    <img src="CaO/PROJECTED/bands-dos.png" class="nav-plot" alt="electStruct_CaO" data-target-slide="slide-projections-CaO">
                    <img src="ZnO/PROJECTED/bands-dos.png" class="nav-plot" alt="electStruct_ZnO" data-target-slide="slide-projections-ZnO">
                </div>

                <div class="caption caption-right" style="color:var(--highlight2-color);font-size: 1.9rem;">ZnO</div>
            </div>

        </div>


            <div class="slide-footer"><span></span><span>15 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 15 1/5: Projections LiF -->
    <div class="slide" id="slide-projections-LiF" data-show-back="true" data-back-target="slide-electStruct" data-skip-target="slide-groundstate-tables">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: Bandas y DOS - LiF</h2>

                <div class="subfigure-row"style="height: 250px;">
                    <h3>Li    </h3>
                    <img src="LiF/PROJECTED/bands_Li_s_dark.png" alt="bands_Li_s_dark" style="height: 100%;">
                    <img src="LiF/PROJECTED/bands_Li_p_dark.png" alt="bands_Li_p_dark" style="height: 100%;">
                    <img src="LiF/PROJECTED/bands_Li_d_dark.png" alt="bands_Li_d_dark" style="height: 100%;">
                    <img src="LiF/PROJECTED/LiF_Li-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>
                <div class="subfigure-row" style="height: 250px;">
                    <h3>F     </h3>
                    <img src="LiF/PROJECTED/bands_F_s_dark.png" alt="bands_F_s_dark" style="height: 100%;">
                    <img src="LiF/PROJECTED/bands_F_p_dark.png" alt="bands_F_p_dark" style="height: 100%;">
                    <img src="LiF/PROJECTED/bands_F_d_dark.png" alt="bands_F_d_dark" style="height: 100%;">
                    <img src="LiF/PROJECTED/LiF_F-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>

            <div class="slide-footer"><span></span><span> 15\(\frac{1}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 15 2/5: Projections MgO -->
    <div class="slide" id="slide-projections-MgO" data-show-back="true" data-back-target="slide-electStruct" data-skip-target="slide-groundstate-tables">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: Bandas y DOS - MgO</h2>

                <div class="subfigure-row" style="height: 250px;">
                    <h3>Mg    </h3>
                    <img src="MgO/PROJECTED/bands_Mg_s_dark.png" alt="bands_Mg_s_dark" style="height: 100%;">
                    <img src="MgO/PROJECTED/bands_Mg_p_dark.png" alt="bands_Mg_p_dark" style="height: 100%;">
                    <img src="MgO/PROJECTED/bands_Mg_d_dark.png" alt="bands_Mg_d_dark" style="height: 100%;">
                    <img src="MgO/PROJECTED/MgO_Mg-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>
                <div class="subfigure-row" style="height: 250px;">
                    <h3>O     </h3>
                    <img src="MgO/PROJECTED/bands_O_s_dark.png" alt="bands_O_s_dark" style="height: 100%;">
                    <img src="MgO/PROJECTED/bands_O_p_dark.png" alt="bands_O_p_dark" style="height: 100%;">
                    <img src="MgO/PROJECTED/bands_O_d_dark.png" alt="bands_O_d_dark" style="height: 100%;">
                    <img src="MgO/PROJECTED/MgO_O-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>

            <div class="slide-footer"><span></span><span> 15\(\frac{2}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 15 3/5: Projections CaO -->
    <div class="slide" id="slide-projections-CaO" data-show-back="true" data-back-target="slide-electStruct" data-skip-target="slide-groundstate-tables">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: Bandas y DOS - CaO</h2>

                <div class="subfigure-row" style="height: 250px;">
                    <h3>Ca    </h3>
                    <img src="CaO/PROJECTED/bands_Ca_s_dark.png" alt="bands_Ca_s_dark" style="height: 100%;">
                    <img src="CaO/PROJECTED/bands_Ca_p_dark.png" alt="bands_Ca_p_dark" style="height: 100%;">
                    <img src="CaO/PROJECTED/bands_Ca_d_dark.png" alt="bands_Ca_d_dark" style="height: 100%;">
                    <img src="CaO/PROJECTED/CaO_Ca-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>
                <div class="subfigure-row" style="height: 250px;">
                    <h3>O     </h3>
                    <img src="CaO/PROJECTED/bands_O_s_dark.png" alt="bands_O_s_dark" style="height: 100%;">
                    <img src="CaO/PROJECTED/bands_O_p_dark.png" alt="bands_O_p_dark" style="height: 100%;">
                    <img src="CaO/PROJECTED/bands_O_d_dark.png" alt="bands_O_d_dark" style="height: 100%;">
                    <img src="CaO/PROJECTED/CaO_O-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>

            <div class="slide-footer"><span></span><span> 15\(\frac{3}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 15 4/5: Projections ZnO -->
    <div class="slide" id="slide-projections-ZnO" data-show-back="true" data-back-target="slide-electStruct" data-skip-target="slide-groundstate-tables">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: Bandas y DOS - ZnO</h2>

                <div class="subfigure-row" style="height: 250px;">
                    <h3>Zn    </h3>
                    <img src="ZnO/PROJECTED/bands_Zn_s_dark.png" alt="bands_Zn_s_dark" style="height: 100%;">
                    <img src="ZnO/PROJECTED/bands_Zn_p_dark.png" alt="bands_Zn_p_dark" style="height: 100%;">
                    <img src="ZnO/PROJECTED/bands_Zn_d_dark.png" alt="bands_Zn_d_dark" style="height: 100%;">
                    <img src="ZnO/PROJECTED/ZnO_Zn-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>
                <div class="subfigure-row" style="height: 250px;">
                    <h3>O     </h3>
                    <img src="ZnO/PROJECTED/bands_O_s_dark.png" alt="bands_O_s_dark" style="height: 100%;">
                    <img src="ZnO/PROJECTED/bands_O_p_dark.png" alt="bands_O_p_dark" style="height: 100%;">
                    <img src="ZnO/PROJECTED/bands_O_d_dark.png" alt="bands_O_d_dark" style="height: 100%;">
                    <img src="ZnO/PROJECTED/ZnO_O-PDOS_dark.png" alt="PDOS_dark" style="height: 100%;">
                </div>

            <div class="slide-footer"><span></span><span> 15\(\frac{4}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 16: Electronic Structure Tables -->
    <div class="slide" data-ignore id="slide-groundstate-tables" data-show-back="true" data-back-target="slide-electStruct">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: Gaps</h2>

            <div style="display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                <table class="thesis-table">
                    <caption>
                        Energ√≠as de gap calculadas, comparadas con las experimentales.
                    </caption>
                    <thead>
                        <tr>
                            <th class="group-header" colspan="4">\(E_{gap}\) [eV]</th>
                        </tr>
                        <tr>
                            <th>Material</th>
                            <th>KS</th>
                            <th>KS + G<sub>0</sub>W<sub>0</sub></th>
                            <th>Exp.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>LiF \(\left(\Gamma - \Gamma\right)\)</td>
                            <td>9.07</td>
                            <td>13.63</td>
                            <td>13.7-14.2 <span class="cite" data-cite="LiF_bandgap_1"></span><span class="cite" data-cite="LiF_bandgap_2"></span></td>
                        </tr>
                        <tr>
                            <td>MgO \(\left(\Gamma - \Gamma\right)\)</td>
                            <td>4.6</td>
                            <td>7.29</td>
                            <td>7.77-7.83 <span class="cite" data-cite="MgO_paper"></span><span class="cite" data-cite="MgO_CaO_bandgap"></span></td>
                        </tr>
                        <tr>
                            <td>CaO \(\left(X - X\right)\)</td>
                            <td>3.5</td>
                            <td>6.02</td>
                            <td>6.88-7.09 <span class="cite" data-cite="CaO_bandgap_2"></span><span class="cite" data-cite="MgO_CaO_bandgap"></span></td>
                        </tr>
                        <tr>
                            <td>ZnO \(\left(\Gamma - \Gamma\right)\)</td>
                            <td>0.72</td>
                            <td>2.27</td>
                            <td>3.4 <span class="cite" data-cite="ZnO_bandgap_1"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <div class="slide-footer"><span></span><span>16 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 17: Optical Plots (Im) -->
    <div class="slide" data-ignore id="slide-optical-Im" data-show-skip="true" data-skip-target="slide-optical-Re">
        <div class="slide-content">
            <h2>Espectros √ìpticos: Absorci√≥n <button class="video-play-btn" data-video-src="excitons.mp4">‚ñ∂</button> </h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom3">
                    <div id="plot-optical_LiF" data-plot-key="plot-optical_LiF" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_LiF"></div>
                    <div id="plot-optical_MgO" data-plot-key="plot-optical_MgO" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_MgO"></div>
                    <div id="plot-optical_CaO" data-plot-key="plot-optical_CaO" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_CaO"></div>
                    <div id="plot-optical_ZnO_ord" data-plot-key="plot-optical_ZnO_ord" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_ZnO"></div>
                    <div id="plot-optical_ZnO_extr" data-plot-key="plot-optical_ZnO_extr" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_ZnO"></div>
                    <!-- TABLE SLOT -->
                    <div class="plot-box table-slot" style="height: 275px;">
                        <div class="table-panel">
                        <table class="thesis-table compact">
                            <caption> Energ√≠as de ligadura de excitones. </caption>
                            <thead>
                                <tr>
                                    <th class="group-header" colspan="4">\(E_{b}\) [eV]</th>
                                </tr>
                                <tr>
                                    <th>Material</th>
                                    <th>\(G_0W_0\) + BSE</th>
                                    <th>Exp.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>LiF</td>
                                    <td>1.870</td>
                                    <td>0.9 <span class="cite" data-cite="LiF_exciton"></span></td>
                                </tr>
                                <tr>
                                    <td>MgO</td>
                                    <td>0.510</td>
                                    <td>0.080 <span class="cite" data-cite="MgO_paper"></span> </td>
                                </tr>
                                <tr>
                                    <td>CaO</td>
                                    <td>0.495</td>
                                    <td>0.060 <span class="cite" data-cite="CaO_exciton"></span> </td>
                                </tr>
                                <tr>
                                    <td>ZnO</td>
                                    <td>
                                        0.362 <br>
                                        0.287 <br>
                                        0.256
                                    </td>
                                    <td>
                                        0.0631   <span class="cite" data-cite="ZnO_exciton"></span><br>
                                        0.0504   <span class="cite" data-cite="ZnO_exciton"></span><br>
                                        0.0489   <span class="cite" data-cite="ZnO_exciton"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>17 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 17 1/5: Excitons LiF -->
    <div class="slide" id="slide-Excitons_LiF" data-show-back="true" data-back-target="slide-optical-Im" data-skip-target="slide-optical-Re">
        <div class="slide-content">
            <h2>Espectros √ìpticos: LiF - excitones</h2>

                <div class="plot-grid-custom2" style="border-radius: 0;">
                    <div id="plot-optical_LiF_detail" data-plot-key="plot-optical_LiF" class="plot-box nav-plot" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="LiF/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000001.OUT.png" alt="exciton_LiF_1_bands" class="img-dark-mode1">
                        <img src="LiF/EXCITONS/optical/excitonWavefunction-000001-000001_iso.png" alt="exciton_LiF_1_wf">
                        <video autoplay muted loop playsinline src="LiF/EXCITONS/optical/LiF_optical_1.mp4.mov" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="LiF/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_LiF_2_bands" class="img-dark-mode1">
                        <img src="LiF/EXCITONS/optical/excitonWavefunction-000002-000001_iso.png" alt="exciton_LiF_2_wf">
                        <video autoplay muted loop playsinline src="LiF/EXCITONS/optical/LiF_optical_2.mp4.mov" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="LiF/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000003.OUT.png" alt="exciton_LiF_3_bands" class="img-dark-mode1">
                        <img src="LiF/EXCITONS/optical/excitonWavefunction-000003-000001_iso.png" alt="exciton_LiF_3_wf">
                        <video autoplay muted loop playsinline src="LiF/EXCITONS/optical/LiF_optical_3.mp4.mov" type="video/mov" >
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>17 \(\frac{1}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 17 2/5: Excitons MgO -->
    <div class="slide" id="slide-Excitons_MgO" data-show-back="true" data-back-target="slide-optical-Im" data-skip-target="slide-optical-Re">
        <div class="slide-content">
            <h2>Espectros √ìpticos: MgO - excitones</h2>

            <div class="plot-grid-custom2" style="border-radius: 0;">
                <div id="plot-optical_MgO_detail" data-plot-key="plot-optical_MgO" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_MgO"></div>
                <div class="subfigure-row">
                    <img src="MgO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000001.OUT.png" alt="exciton_MgO_1_bands" class="img-dark-mode1">
                    <img src="MgO/EXCITONS/optical/excitonWavefunction-000001-000001_iso.png" alt="exciton_MgO_1">
                    <video autoplay muted loop playsinline src="MgO/EXCITONS/optical/MgO_optical_1.mp4.mov" type="video/mov" >
                </div>
            </div>

            <div class="slide-footer"><span></span><span>17 \(\frac{2}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 17 3/5: Excitons CaO -->
    <div class="slide" id="slide-Excitons_CaO" data-show-back="true" data-back-target="slide-optical-Im" data-skip-target="slide-optical-Re">
        <div class="slide-content">
            <h2>Espectros √ìpticos: CaO - excitones</h2>

                <div class="plot-grid-custom2" no-round>
                    <div id="plot-optical_CaO_detail" data-plot-key="plot-optical_CaO" class="plot-box nav-plot" style="height: 275px;" data-target-slide="slide-Excitons_CaO"></div>
                    <div></div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_CaO_1_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/optical/excitonWavefunction-000002-000001_iso.png" alt="exciton_CaO_1_wf">
                        <video autoplay muted loop playsinline src="CaO/EXCITONS/optical/CaO_optical_2.mp4.mov" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000005.OUT.png" alt="exciton_CaO_2_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/optical/excitonWavefunction-000002-000005_iso.png" alt="exciton_CaO_2_wf">
                        <video autoplay muted loop playsinline src="CaO/EXCITONS/optical/CaO_optical_5.mp4.mov" type="video/mov" >
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>17 \(\frac{3}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 17 4/5: Excitons ZnO -->
    <div class="slide" id="slide-Excitons_ZnO" data-show-back="true" data-back-target="slide-optical-Im" data-skip-target="slide-optical-Re">
        <div class="slide-content">
            <h2>Espectros √ìpticos: ZnO - excitones</h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row">
                        <img src="ZnO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_ZnO_1_bands" class="img-dark-mode1">
                        <img src="ZnO/EXCITONS/optical/excitonWavefunction-000002-000001_iso.png" alt="exciton_ZnO_1_wf">
                        <video autoplay muted loop playsinline src="ZnO/EXCITONS/optical/optical_1.mp4.mov" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="ZnO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_ZnO_1_bands" class="img-dark-mode1">
                        <img src="ZnO/EXCITONS/optical/excitonWavefunction-000002-000002_iso.png" alt="exciton_ZnO_1_wf">
                        <video autoplay muted loop playsinline src="ZnO/EXCITONS/optical/optical_2.mp4.mov" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="ZnO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_ZnO_1_bands" class="img-dark-mode1">
                        <img src="ZnO/EXCITONS/optical/excitonWavefunction-000002-000003_iso.png" alt="exciton_ZnO_1_wf">
                        <video autoplay muted loop playsinline src="ZnO/EXCITONS/optical/optical_3.mp4.mov" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="ZnO/EXCITONS/optical/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_ZnO_1_bands" class="img-dark-mode1">
                        <img src="ZnO/EXCITONS/optical/excitonWavefunction-000002-000004_iso.png" alt="exciton_ZnO_1_wf">
                        <video autoplay muted loop playsinline src="ZnO/EXCITONS/optical/optical_4.mp4.mov" type="video/mov" >
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>17 \(\frac{4}{5}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 18: Optical Plots (Re) -->
    <div class="slide" data-ignore id="slide-optical-Re" data-show-back="true" data-back-target="slide-optical-Im">
        <div class="slide-content">
            <h2>Espectros √ìpticos: Dispersi√≥n</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom3">
                    <div id="plot-optical_LiF_Re" data-plot-key="plot-optical_LiF_Re" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-optical_MgO_Re" data-plot-key="plot-optical_MgO_Re" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-optical_CaO_Re" data-plot-key="plot-optical_CaO_Re" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-optical_ZnO_Re_ord" data-plot-key="plot-optical_ZnO_Re_ord" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-optical_ZnO_Re_extr" data-plot-key="plot-optical_ZnO_Re_extr" class="plot-box" style="height: 275px;"></div>
                    <!-- TABLE SLOT -->
                    <div class="plot-box table-slot" style="height: 275px;">
                        <div class="table-panel">
                            <table class="thesis-table compact">
                                <caption>Constantes diel√©ctricas electr√≥nicas est√°ticas macrosc√≥picas \(\varepsilon_\infty\) </caption>
                                <thead>
                                    <tr>
                                        <th class="group-header" colspan="4">\(\varepsilon_\infty\)</th>
                                    </tr>
                                    <tr>
                                        <th>Material</th>
                                        <th>\(G_0W_0\) + BSE</th>
                                        <th>Exp.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>LiF</td>
                                        <td>1.81</td>
                                        <td>1.96 <span class="cite" data-cite="LiF_ZnO_epsInf"></span></td>
                                    </tr>
                                    <tr>
                                        <td>MgO</td>
                                        <td>2.87</td>
                                        <td>2.944 <span class="cite" data-cite="dielectric_constants"></span> - 2.95 <span class="cite" data-cite="MgO_paper"></span></td>
                                    </tr>
                                    <tr>
                                        <td>CaO</td>
                                        <td>3.02</td>
                                        <td>3.27 <span class="cite" data-cite="dielectric_constants"></span> - 3.33 </span><span class="cite" data-cite="CaO_epsInf"></span></td>
                                    </tr>
                                    <tr>
                                        <td>ZnO</td>
                                        <td>3.74 \(\left(\perp\right)\) - 3.77 \(\left(\parallel\right)\)</td>
                                        <td>3.70 \(\left(\perp\right)\) - 3.75 \(\left(\parallel\right)\) <span class="cite" data-cite="dielectric_constants"></span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>18 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19: XANES Plots (Im) -->
    <div class="slide" id="slide-XANES"  data-show-back="true" data-back-target="slide-optical-Re"data-show-skip="true" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>XANES: Espectros de absorci√≥n de rayos-X cerca del borde</h2>

            <div style="height: 100%; margin: 0 auto;">
                <div class="plot-grid-custom4">
                    <div class="row-with-captions1">
                        <p class="material-title">LiF</p>
                        <img src="LiF/LiF_structure.png" alt="Struct_LiF" style="background-color: var(--bg-color);" class="XANES" data-target-slide='slide-XANES-Im-LiF'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">Li-\(K\)</p>
                        <img src="LiF/thumbnail_Li_K.png" alt="thumbnail_Li_K" class="XANES"  data-target-slide='slide-XANES-Im-LiF-Li_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">F-\(K\)</p>
                        <img src="LiF/thumbnail_F_K.png" alt="thumbnail_F_K" class="XANES" data-target-slide='slide-XANES-Im-LiF-F_K'>
                    </div>
                    <div ></div>

                    <div class="row-with-captions1">
                        <p class="material-title">MgO</p>
                        <img src="MgO/MgO_structure.png" alt="Struct_MgO" style="background-color: var(--bg-color);" class="XANES"data-target-slide='slide-XANES-Im-MgO'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">Mg-\(K\)</p>
                        <img src="MgO/thumbnail_Mg_K.png" alt="thumbnail_Mg_K"class="XANES" data-target-slide='slide-XANES-Im-MgO-Mg_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">O-\(K\)</p>
                        <img src="MgO/thumbnail_O_K.png" alt="thumbnail_O_K"class="XANES"data-target-slide='slide-XANES-Im-MgO-O_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">Mg-\(L_{23}\)</p>
                        <img src="MgO/thumbnail_Mg_L23.png" alt="thumbnail_Mg_L23"class="XANES"data-target-slide='slide-XANES-Im-MgO-Mg_L23'>
                    </div>

                    <div class="row-with-captions1">
                        <p class="material-title">CaO</p>
                        <img src="CaO/CaO_structure.png" alt="Struct_CaO" style="background-color: var(--bg-color);" class="XANES"data-target-slide='slide-XANES-Im-CaO'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">Ca-\(K\)</p>
                        <img src="CaO/thumbnail_Ca_K.png" alt="thumbnail_Ca_K" style="background-color: var(--bg2-color); border: 2px solid var(--border-color);"  data-target-slide='slide-XANES-Im-CaO-Ca_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">O-\(K\)</p>
                        <img src="CaO/thumbnail_O_K.png" alt="thumbnail_O_K"class="XANES"data-target-slide='slide-XANES-Im-CaO-O_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title" style="width: 100px">Ca-\(L_{23}\)</p>
                        <img src="CaO/thumbnail_Ca_L23.png" alt="thumbnail_Ca_L23"class="XANES"style="width: 200px" data-target-slide='slide-XANES-Im-CaO-Ca_L23'>
                    </div>

                    <div class="row-with-captions1">
                        <p class="material-title">ZnO</p>
                        <img src="ZnO/ZnO_structure.png" alt="Struct_ZnO" style="background-color: var(--bg-color);" class="XANES" data-target-slide='slide-XANES-Im-ZnO'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">Zn-\(K\)</p>
                        <img src="ZnO/thumbnail_Zn_K_perp.png" alt="thumbnail_Zn_K_perp"class="XANES"data-target-slide='slide-XANES-Im-ZnO-Zn_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">O-\(K\)</p>
                        <img src="ZnO/thumbnail_O_K_perp.png" alt="thumbnail_O_K_perp"class="XANES" data-target-slide='slide-XANES-Im-ZnO-O_K'>
                    </div>
                    <div class="row-with-captions1">
                        <p class="material-title">Zn-\(L_{23}\)</p>
                        <img src="ZnO/thumbnail_Zn_L23_perp.png" alt="thumbnail_Zn_L23_perp"class="XANES"data-target-slide='slide-XANES-Im-ZnO-Zn_L23'>
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 1/12: XANES Plots (Im) LiF -->
    <div class="slide" id="slide-XANES-Im-LiF" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: LiF</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom3">
                    <div id="plot-XANES_LiF_F_K" data-plot-key="plot-XANES_LiF_F_K" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_LiF_Li_K" data-plot-key="plot-XANES_LiF_Li_K" class="plot-box" style="height: 275px;"></div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{1}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 2/12: XANES Plots (Im) LiF Li-K -->
    <div class="slide" id="slide-XANES-Im-LiF-Li_K" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>XANES: LiF - Borde K del Li</h2>

            <div class="plot-grid-custom2" style="border-radius: 0;">
                <div id="plot-XANES_LiF_Li_K_detail" data-plot-key="plot-XANES_LiF_Li_K" class="plot-box" style="height: 275px;"></div>
                <div class="subfigure-row">
                    <img src="LiF/EXCITONS/Li-K/excitonWavefunction-000002-iso.png" alt="exciton_Li_1_bands" class="img-dark-mode1">
                    <img src="LiF/EXCITONS/Li-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000002.OUT.png" alt="exciton_Li_1_wf" class="img-dark-mode1">
                    <video autoplay muted loop playsinline src="" type="video/mov" >
                </div>
                <div class="subfigure-row">
                    <img src="LiF/EXCITONS/Li-K/excitonWavefunction-000003-iso.png" alt="exciton_Li_2_bands" class="img-dark-mode1">
                    <img src="LiF/EXCITONS/Li-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000003.OUT.png" alt="exciton_Li_2_wf" class="img-dark-mode1">
                    <video autoplay muted loop playsinline src="" type="video/mov" >
                </div>
                <div class="subfigure-row">
                    <img src="LiF/EXCITONS/Li-K/excitonWavefunction-000004-iso.png" alt="exciton_Li_3_bands" class="img-dark-mode1">
                    <img src="LiF/EXCITONS/Li-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000004.OUT.png" alt="exciton_Li_3_wf" class="img-dark-mode1">
                    <video autoplay muted loop playsinline src="" type="video/mov" >
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{2}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 3/12: XANES Plots (Im) LiF F-K -->
    <div class="slide" id="slide-XANES-Im-LiF-F_K" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>XANES: LiF - Borde K del F</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom2">
                    <div id="plot-XANES_LiF_F_K_detail" data-plot-key="plot-XANES_LiF_F_K" class="plot-box" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="LiF/EXCITONS/F-K/excitonWavefunction-000004-iso.png" alt="exciton_F_1_bands" class="img-dark-mode1">
                        <img src="LiF/EXCITONS/F-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000004.OUT.png" alt="exciton_F_1_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="LiF/EXCITONS/F-K/excitonWavefunction-000007-iso.png" alt="exciton_F_2_bands" class="img-dark-mode1">
                        <img src="LiF/EXCITONS/F-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000007.OUT.png" alt="exciton_F_2_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="LiF/EXCITONS/F-K/excitonWavefunction-000008-iso.png" alt="exciton_F_3_bands" class="img-dark-mode1">
                        <img src="LiF/EXCITONS/F-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000008.OUT.png" alt="exciton_F_3_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{3}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 4/12: XANES Plots (Im) MgO -->
    <div class="slide" id="slide-XANES-Im-MgO" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: MgO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom3">
                    <div id="plot-XANES_MgO_Mg_L23" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_MgO_O_K" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_MgO_Mg_K" class="plot-box" style="height: 275px;"></div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{4}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 5/12: XANES Plots (Im) MgO Mg-K -->
    <div class="slide" id="slide-XANES-Im-MgO-Mg_K" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: MgO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom2">
                    <div id="plot-XANES_MgO_Mg_K_detail" data-plot-key="plot-XANES_MgO_Mg_K" class="plot-box" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/Mg-K/excitonWavefunction-000008-iso.png" alt="exciton_Mg_K_1_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/Mg-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000008.OUT.png" alt="exciton_Mg_K_1_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/Mg-K/excitonWavefunction-000028-iso.png" alt="exciton_Mg_K_1_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/Mg-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000028.OUT.png" alt="exciton_Mg_K_2_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{5}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 6/12: XANES Plots (Im) MgO O-K -->
    <div class="slide" id="slide-XANES-Im-MgO-O_K" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: MgO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom2">
                    <div id="plot-XANES_MgO_O_K_detail" data-plot-key="plot-XANES_MgO_O_K" class="plot-box" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/O-K/excitonWavefunction-000010-iso.png" alt="exciton_O_K_1_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/O-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000010.OUT.png" alt="exciton_O_K_1_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/O-K/excitonWavefunction-000044-iso.png" alt="exciton_O_K_2_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/O-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000044.OUT.png" alt="exciton_O_K_2_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/O-K/excitonWavefunction-000218-iso.png" alt="exciton_O_K_3_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/O-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000218.OUT.png" alt="exciton_O_K_3_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{6}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 7/12: XANES Plots (Im) MgO Mg-L23 -->
    <div class="slide" id="slide-XANES-Im-MgO-Mg_L23" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: MgO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom2">
                    <div id="plot-XANES_MgO_Mg_L23_detail" data-plot-key="plot-XANES_MgO_Mg_L23" class="plot-box" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/Mg-L23/excitonWavefunction-000001-000001_iso.png" alt="exciton_Mg_L23_1_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/Mg-L23/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000001.OUT.png" alt="exciton_Mg_L23_1_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/Mg-L23/excitonWavefunction-000001-000004_iso.png" alt="exciton_Mg_L23_2_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/Mg-L23/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000004.OUT.png" alt="exciton_Mg_L23_2_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/Mg-L23/excitonWavefunction-000001-000046_iso.png" alt="exciton_Mg_L23_3_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/Mg-L23/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000046.OUT.png" alt="exciton_Mg_L23_3_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="MgO/EXCITONS/Mg-L23/excitonWavefunction-000001-000186_iso.png" alt="exciton_Mg_L23_4_bands" class="img-dark-mode1">
                        <img src="MgO/EXCITONS/Mg-L23/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000186.OUT.png" alt="exciton_Mg_L23_4_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{7}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 8/12: XANES Plots (Im) CaO -->
    <div class="slide" id="slide-XANES-Im-CaO" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: CaO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom3">
                    <div id="plot-XANES_CaO_Ca_L23" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_CaO_O_K" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_CaO_Ca_K" class="plot-box" style="height: 275px;"></div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{8}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 9/12: XANES Plots (Im) CaO Ca-K-->
    <div class="slide" id="slide-XANES-Im-CaO-Ca_K" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: CaO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom2">
                    <div id="plot-XANES_CaO_Ca_L23_detail" data-plot-key="plot-XANES_CaO_Ca_L23" class="plot-box" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/Ca-K/excitonWavefunction-000212-iso.png" alt="exciton_Ca_K_1_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/Ca-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000212.OUT.png" alt="exciton_Ca_K_1_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/Ca-K/excitonWavefunction-001542-iso.png" alt="exciton_Ca_K_2_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/Ca-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA001542.OUT.png" alt="exciton_Ca_K_2_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/Ca-K/excitonWavefunction-001884-full.png" alt="exciton_Ca_K_3_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/Ca-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA001884.OUT.png" alt="exciton_Ca_K_3_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/Ca-K/excitonWavefunction-002198-iso.png" alt="exciton_Ca_K_4_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/Ca-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA002198.OUT.png" alt="exciton_Ca_K_4_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{9}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 10/12: XANES Plots (Im) CaO O-K -->
    <div class="slide" id="slide-XANES-Im-CaO-O_K" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: CaO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom2">
                    <div id="plot-XANES_CaO_O_K_detail" data-plot-key="plot-XANES_CaO_O_K" class="plot-box" style="height: 275px;"></div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/O-K/excitonWavefunction-000024-iso.png" alt="exciton_O_K_1_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/O-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000024.OUT.png" alt="exciton_O_K_1_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/O-K/excitonWavefunction-000078-iso.png" alt="exciton_O_K_2_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/O-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000078.OUT.png" alt="exciton_O_K_2_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                    <div class="subfigure-row">
                        <img src="CaO/EXCITONS/O-K/excitonWavefunction-000214-iso.png" alt="exciton_O_K_3_bands" class="img-dark-mode1">
                        <img src="CaO/EXCITONS/O-K/KPATH_BSE-singlet-TDA-BAR_SCR-full_QMT001_LAMBDA000214.OUT.png" alt="exciton_O_K_3_wf" class="img-dark-mode1">
                        <video autoplay muted loop playsinline src="" type="video/mov" >
                    </div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{10}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 19 11/12: XANES Plots (Im) ZnO -->
    <div class="slide" id="slide-XANES-Im-ZnO" data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-structure">
        <div class="slide-content">
            <h2>Espectros XANES: ZnO</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom3">
                    <div id="plot-XANES_ZnO_O_K_ord" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_ZnO_Zn_L23_ord" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_ZnO_Zn_K_ord" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_ZnO_O_K_extr" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_ZnO_Zn_L23_extr" class="plot-box" style="height: 275px;"></div>
                    <div id="plot-XANES_ZnO_Zn_K_extr" class="plot-box" style="height: 275px;"></div>
                </div>
            </div>

            <div class="slide-footer"><span></span><span>19 \(\frac{11}{12}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20: Defects structure -->
    <div class="slide" id="slide-defects-structure" data-ignore data-show-back="true" data-back-target="slide-XANES" data-skip-target="slide-defects-overlay">
        <div class="slide-content">
            <h2>Defectos: Estructura Cristalina</h2>

            <div style="width: 95%; height: 70%; margin: 0 auto;">
                <div class="plot-grid-custom4">
                    <h3> LiF </h3>
                    <h3> Vacante: Li</h3>
                    <h3> Vacante: F</h3>
                    <h3> Dopante: Na</h3>
                    <img src="defect/images/LiF/LiF_prist.png" alt="Struct_LiF_prist" data-target-slide='slide-defects-LiF-prist'>
                    <img src="defect/images/LiF/LiF_Li-vac.png" alt="Struct_LiF_Li-vac" data-target-slide='slide-defects-LiF-Li'>
                    <img src="defect/images/LiF/LiF_F-vac.png" alt="Struct_LiF_F-vac" data-target-slide='slide-defects-LiF-F'>
                    <img src="defect/images/LiF/LiF-Na.png" alt="Struct_LiF-Na" data-target-slide='slide-defects-LiF-Na'>
                    <h3> Dopante: Mg</h3>
                    <h3> Dopante: Be</h3>
                    <h3> ZnO</h3>
                    <h3> Dopante: Mn</h3>
                    <img src="defect/images/LiF/LiF-Mg.png" alt="Struct_LiF-Mg" data-target-slide='slide-defects-LiF-Mg'>
                    <img src="defect/images/LiF/LiF-Be.png" alt="Struct_LiF-Be" data-target-slide='slide-defects-LiF-Be'>

                    <img src="defect/images/ZnO/ZnO_prist.png" alt="Struct_ZnO_prist" data-target-slide='slide-defects-ZnO-prist'>
                    <img src="defect/images/ZnO/ZnO_Mn-doped.png" alt="Struct_ZnO_Mn-doped" data-target-slide='slide-defects-ZnO-Mn'>

                </div>
            </div>


            <div class="slide-footer"><span></span><span>20 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20 1/9: Defects - LiF prist-->
    <div class="slide" id="slide-defects-LiF-prist" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: LiF </h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/prist/electStruct_prist_KS_dark.png" alt="bands_LiF_prist_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/prist/electStruct_prist_GW_dark.png" alt="bands_LiF_prist_dark" style="height: 100%;">
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>21 \(\frac{1}{9}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20 2/9: Defects - LiF Li -->
    <div class="slide" id="slide-defects-LiF-Li" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: LiF - Li vacante</h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Li-vac_KS_dark.png" alt="Li_vac_KS_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Li+/Li+-vac_KS_dark.png" alt="Li+_vac_KS_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Li+/Li+-vac_Gw_dark.png" alt="Li+vac_Gw_dark" style="height: 100%;">
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>20 \(\frac{2}{9}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20 3/9: Defects - LiF F -->
    <div class="slide" id="slide-defects-LiF-F" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: LiF - F vacante</h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/F-vac_KS_dark.png" alt="F_vac_KS_dark" style="height: 100%;">
                    </div>
                    <div></div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/F-/F--vac_KS_dark.png" alt="F-_vac_KS_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/F-/F--vac_Gw_dark.png" alt="F-vac_GW_dark" style="height: 100%;">
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>20 \(\frac{1}{9}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20 4/9: Defects - LiF Na -->
    <div class="slide" id="slide-defects-LiF-Na" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: LiF - dopante Na </h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Na/Na-doped_KS_dark.png" alt="Na_vac_KS_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Na/Na-doped_GW_dark.png" alt="Na_vac_GW_dark" style="height: 100%;">
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>20 \(\frac{1}{9}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20 5/9: Defects - LiF Mg -->
    <div class="slide" id="slide-defects-LiF-Mg" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: LiF - dopante Mg </h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Mg-doped_KS_dark.png" alt="Mg_vac_KS_dark" style="height: 100%;">
                    </div>
                    <div></div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Mg+/Mg+-doped_KS_dark.png" alt="Mg+_vac_GW_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Mg+/Mg+-doped_GW_dark.png" alt="Mg+_vac_GW_dark" style="height: 100%;">
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>20 \(\frac{1}{9}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 20 6/9: Defects - LiF Be -->
    <div class="slide" id="slide-defects-LiF-Be" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Estructura Electr√≥nica: LiF - dopante Be\(^+\) </h2>

                <div class="plot-grid-custom2">
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Be+/Be+-doped_KS_dark.png" alt="Be+_vac_GW_dark" style="height: 100%;">
                    </div>
                    <div class="subfigure-row"style="height: 250px;">
                        <img src="defect/images/LiF/Be+/Be+-doped_GW_dark.png" alt="Be+_vac_GW_dark" style="height: 100%;">
                    </div>
                </div>

            <div class="slide-footer"><span></span><span>20 \(\frac{1}{9}\) / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 21: Defects - LiF overlay -->
    <div class="slide" id="slide-defects-overlay" data-mode="KS" data-show-back="true" data-back-target="slide-defects-structure" data-skip-target="slide-conclusions">
        <div class="slide-content">
            <h2>Defectos: LiF - Estructura Electr√≥nica (KS) </h2>
            <!-- Mode selector -->
            <div class="overlay-mode-controls">
                <button class="mode-btn active" onclick="toggleMode('KS')">KS</button>
                <button class="mode-btn" onclick="toggleMode('GW')">GW</button>
            </div>

            <!-- KS container -->
            <div class="overlay-plot-container mode-container active" data-mode="KS">
                <img src="defect/images/LiF/prist/electStruct_prist_KS_v2_dark.png" class="plot reference">

                <img src="defect/images/LiF/Li+/Li+-vac_KS_dark.png" class="plot overlay" id="KS_ov1">
                <img src="defect/images/LiF/F-/F--vac_KS_dark.png" class="plot overlay" id="KS_ov2">
                <img src="defect/images/LiF/Na/Na-doped_KS_dark.png" class="plot overlay" id="KS_ov3">
                <img src="defect/images/LiF/Mg+/Mg+-doped_KS_dark.png" class="plot overlay" id="KS_ov4">
                <img src="defect/images/LiF/Be+/Be+-doped_KS_dark.png" class="plot overlay" id="KS_ov5">
            </div>

            <!-- GW container -->
            <div class="overlay-plot-container mode-container" data-mode="GW">
                <img src="defect/images/LiF/prist/electStruct_prist_GW_v2_dark.png" class="plot reference">

                <img src="defect/images/LiF/Li+/Li+-vac_GW_dark.png" class="plot overlay" id="GW_ov1">
                <img src="defect/images/LiF/F-/F--vac_GW_dark.png" class="plot overlay" id="GW_ov2">
                <img src="defect/images/LiF/Na/Na-doped_GW_dark.png" class="plot overlay" id="GW_ov3">
                <img src="defect/images/LiF/Mg+/Mg+-doped_GW_dark.png" class="plot overlay" id="GW_ov4">
                <img src="defect/images/LiF/Be+/Be+-doped_GW_dark.png" class="plot overlay" id="GW_ov5">
            </div>

            <div class="overlay-controls">

                <!-- Vacancies row -->
                <div class="overlay-row">
                    <span class="overlay-row-label" style="font-size: 1.8rem;">Vacante:</span>
                    <button data-ov="1" onclick="toggleOverlay(this)">Li\(^+\)</button>
                    <button data-ov="2" onclick="toggleOverlay(this)">F\(^-\)</button>
                </div>

                <!-- Dopants row -->
                <div class="overlay-row">
                    <span class="overlay-row-label" style="font-size: 1.8rem;">Dopante:</span>
                    <button data-ov="3" onclick="toggleOverlay(this)">Na</button>
                    <button data-ov="4" onclick="toggleOverlay(this)">Mg\(^+\)</button>
                    <button data-ov="5" onclick="toggleOverlay(this)">Be\(^+\)</button>
                </div>

            </div>


        </div>
    </div>

    <!-- SLIDE 22: Conclusiones -->
    <div class="slide" id="slide-conclusions" data-show-back="true" data-back-target="slide-defects-overlay">
        <div class="slide-content">
            <h2>Conclusiones</h2>

            <div class="conclusions-grid">

                <!-- Estado fundamental -->
                <div class="conclusion-block appear-step active">
                    <h3>Estado fundamental</h3>
                    <ul>
                        <li data-popup="Las estructuras optimizadas con DFT/PBEsol reproducen los par√°metros experimentales con desviaciones t√≠picamente menores al 1%.">
                            Par√°metros de red en excelente acuerdo experimental
                        </li>
                        <li data-popup="Las correcciones G‚ÇÄW‚ÇÄ abren el gap electr√≥nico respecto al nivel Kohn-Sham, actuando principalmente como un corrimiento r√≠gido de las bandas de conducci√≥n.">
                            G‚ÇÄW‚ÇÄ mejora sustancialmente la descripci√≥n del gap
                        </li>
                    </ul>
                </div>

                <!-- √ìptica -->
                <div class="conclusion-block appear-step">
                    <h3>√ìptica</h3>
                    <ul>
                        <li data-popup="La inclusi√≥n expl√≠cita de la interacci√≥n electr√≥n-hueco mediante la ecuaci√≥n de Bethe-Salpeter es esencial para reproducir la forma espectral y el umbral √≥ptico.">
                            Excelente reproducci√≥n de la forma espectral
                        </li>
                        <li data-popup="Las energ√≠as de ligadura excit√≥nica resultan sistem√°ticamente mayores que las experimentales, sugiriendo limitaciones en la descripci√≥n del apantallamiento.">
                            Ligera sobrestimaci√≥n de la ligadura excit√≥nica
                        </li>
                    </ul>
                </div>

                <!-- XANES -->
                <div class="conclusion-block appear-step">
                    <h3>XANES</h3>
                    <ul>
                        <li data-popup="La BSE describe con gran precisi√≥n el umbral de absorci√≥n y los picos excit√≥nicos de core en aislantes y semiconductores.">
                            Umbral y picos excit√≥nicos bien reproducidos
                        </li>
                        <li data-popup="Persisten discrepancias de intensidad relativa en materiales con fuerte car√°cter d, como CaO y ZnO.">
                            Limitaciones en sistemas con estados d dominantes
                        </li>
                    </ul>
                </div>

                <!-- Defectos -->
                <div class="conclusion-block appear-step">
                    <h3>Defectos</h3>
                    <ul>
                        <li data-popup="La introducci√≥n de defectos genera estados localizados dentro del gap o cruzando el nivel de Fermi.">
                            Estados electr√≥nicos localizados inducidos por defectos
                        </li>
                        <li data-popup="El estudio abre el camino a aplicar GW y BSE en sistemas defectivos cargados, un desaf√≠o computacional relevante.">
                            Base s√≥lida para estudios excit√≥nicos futuros
                        </li>
                    </ul>
                </div>

            </div>

            <div class="slide-footer"><span></span><span>22 / 24</span></div>
        </div>
    </div>

    <!-- SLIDE 23: Acknowledgements -->
    <div class="slide" id="slide-acknowledgements">
        <div class="slide-content credit-slide">

            <h2>Agradecimientos</h2>

            <div class="credit-viewport">
                <div class="credit-roll">

                    <h3>Directora</h3>
                    <p>Dra. Gabriela Beatriz Grad</p>

                    <h3>Supervisor</h3>
                    <p>Dr. Edgardo Venusto Bonzi</p>

                    <h3>Jurado</h3>
                    <p>Dra. Gabriela Grad       -  Presidente </p>
                    <p>Dr. Francisco Tamarit    -  Vocal </p>
                    <p>Dra. Noelia Bajales Luna -  Vocal </p>
                    <p>Dra. Ana Karina Chattah  -  Suplente </p>
                    <p>Dr. Edgardo Bonzi        -  Suplente </p>

                    <h3>Instituciones</h3>
                    <p>FaMAF - Universidad Nacional de C√≥rdoba</p>
                    <p>CCAD  - Centro de C√≥mputo de Alto Desempe√±o </p>

                    <h3>Otras colaboraciones</h3>
                    <p>Claudia Draxl y compan√≠a</p>
                    <p>Horacio Pastawski</p>

                    <h3>Familia y conocidos</h3>
                    <p>Hugo Acito       -   Padre</p>
                    <p>Guadalupe Pino   -   Madre</p>
                    <p>Flor             -   Novia</p>
                    <p>Hermanos, t√≠os, primos y familia lejana</p>
                    <p>Amigos y compa√±eros</p>

                    <h3>C√≥digos y recursos</h3>
                    <p><em style="font-family: 'Helvetica Neue'" >exciting</em> - Simulaci√≥n</p>
                    <p ><em style="font-family: 'Helvetica Neue'" >VESTA</em> - Visualizaci√≥n</p>
                    <p ><em style="font-family: 'Helvetica Neue'" >XCrySDen</em> - Visualizaci√≥n</p>

                    <h3>P√∫blico</h3>
                    <p class="final-line">Gracias por su atenci√≥n</p>

                </div>
            </div>

            <div class="slide-footer"><span></span><span>23 / 24</span></div>

        </div>
    </div>

    <!-- SLIDE 24: Citations -->
    <div class="slide" id="slide-citations">
        <div class="slide-content citations-slide">

            <h2>Referencias</h2>

            <div class="credit-viewport">
                <div class="credit-lane" id="ref-lane-1"></div>
                <div class="credit-lane" id="ref-lane-2"></div>
            </div>

            <div class="slide-footer"><span></span><span>24 / 24</span></div>

        </div>
    </div>

    <div id="cursor-halo"></div>
    <div id="cite-tooltip"></div>


    <!-- CONTROLS -->
    <div class="controls-overlay">
        <button class="nav-btn" onclick="prevSlide()"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="nav-btn" onclick="nextSlide()"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="nav-btn" onclick="toggleFullScreen()"><i class="fa-solid fa-expand"></i></button>
    </div>
    <div class="progress-bar" id="progressBar"></div>
    <div id="video-overlay" class="video-overlay hidden">
        <div class="video-container">
            <video id="overlay-video" controls></video>
        </div>
    </div>



    <script>

        // Ignoring slides
        const DEV_MODE = false;
        if (DEV_MODE) document.querySelectorAll("[data-ignore]").forEach(el => el.remove());

        // GLOBAL COLOR PALETTE
        function css(name) {
            return getComputedStyle(document.documentElement)
                .getPropertyValue(name)
                .trim();
        }

        const PALETTE = {
            background: css("--bg-color"),
            border: css("--border-color"),
            shadow: css("--shadow-color"),
            axes: css("--axes-color"),
            text: css("--text-color"),
            highlight2: css("--highlight1-color"),
            highlight2: css("--highlight1-color"),
            curve1: css("--curve1-color"),
            curve2: css("--curve2-color"),
            curve3: css("--curve3-color"),
            curve4: css("--curve4-color"),
            curve5: css("--curve5-color"),

            lattice: css("--lattice-color"),       // Yellow
            photon: css("--particle-photon"),       // Yellow
            electron: css("--particle-electron"),     // Blue
            ion: css("--particle-ion"),          // Reds
            interaction: 'rgba(77, 77, 255, 0.8)', // Brighter interaction line

            arrow: css("--arrow-color"),

            valenceBand: css("--valence-band"),
            conductionBand: css("--conduction-band"),

            gapArrow: css("--gap-arrow"),
            xcArrow: css("--xc-arrow"),
            guideLines: css("--guide-lines"),

            incident: css("--incident"),
            transmitted: css("--transmitted"),
            absorbed: css("--absorbed")
        };

        /* --- SCENE MANAGER LOGIC --- */
        let currentSlide = 0;
        let lastOverviewSlide = null;

        // Slide 1 State Tracker
        // -1: Intro, 0..7: Steps
        let slide1Step = -1;

        const slides = document.querySelectorAll('.slide');
        const progressBar = document.getElementById('progressBar');

        function showSlide(index) {
            if (index < 0) index = 0;
            if (index >= slides.length) index = slides.length - 1;

            // Save overview when leaving it
            if (!slides[currentSlide].dataset.showBack &&
                slides[index].dataset.showBack === "true") {
                lastOverviewSlide = currentSlide;
            }

            slides.forEach(slide => slide.classList.remove('active'));
            slides[index].classList.add('active');
            currentSlide = index;
            updateProgress();

            // Stop All
            Object.keys(anims).forEach(k => { if(anims[k]) cancelAnimationFrame(anims[k]); anims[k]=null; });
            // üîë RESET STATES
            Object.keys(animState).forEach(k => animState[k] = false);

            // Start Specific
            if (slides[index].id === 'slide1') {
                // Check if we are in the workflow state to restart that animation if needed
                if(slide1Step >= 2 && slide1Step <= 4) initExpSetupAnim();
            }
            if (slides[index].id === 'slide-DFT-intro1') initMbDftAnim();
            else if (slides[index].id === 'slide-BSE-intro') resizeExcitation();
            else if (slides[index].id === 'slide-DFT-intro2') initKSAnim();
            else if (slides[index].id === 'slide-GW-green') initGreensAnim();
            else if (slides[index].id === 'slide-GW-intro') initScreeningBox('screenElectronCanvas', 'electron');
            else if (slides[index].id === 'slide-excitons-type') init_excitons();
            if (slides[index].id === 'slide-conclusions') {
                conclusionsStep = -1;
                updateConclusionsStep(-1);
            }


        }

        /* --- ROBUST STATE MACHINE --- */
        function updateSlide1State(step) {
            const titleLayer = document.getElementById('layer-title');
            const workLayer  = document.getElementById('layer-workflow');
            const bandsLayer = document.getElementById('layer-static-bands');
            const steps = document.querySelectorAll('.step-text');

            // Reset everything
            steps.forEach(s => s.classList.remove('active'));

            titleLayer.classList.add('hidden');
            workLayer.classList.add('hidden');
            bandsLayer.classList.add('hidden');

            if (anims.expSetup) {
                cancelAnimationFrame(anims.expSetup);
                anims.expSetup = null;
            }

            // ‚úÖ HARD GUARD
            if (step === -1) {
                titleLayer.classList.remove('hidden');
                return;
            }

            // Layer visibility
            if (step >= 2 && step <= 4) {
                workLayer.classList.remove('hidden');
                initExpSetupAnim();
            } else if (step === 6) {
                bandsLayer.classList.remove('hidden');
                drawStaticBands();
            } else {
                titleLayer.classList.remove('hidden');
            }

            // Apply Steps
            const p1 = document.getElementById('plot-group-1');
            const a1 = document.getElementById('arrow-1');
            const p2 = document.getElementById('plot-group-2');
            const a2 = document.getElementById('arrow-2');
            const p3 = document.getElementById('plot-group-3');
            const plots = [p1, a1, p2, a2, p3];
            plots.forEach(p => { p.classList.remove('plot-visible'); p.classList.add('plot-hidden'); });

            if (step === 0) document.getElementById('step-0').classList.add('active');
            else if (step === 1) document.getElementById('step-1').classList.add('active');
            else if (step === 2) { p1.classList.add('plot-visible'); p1.classList.remove('plot-hidden'); }
            else if (step === 3) {
                p1.classList.add('plot-visible'); p1.classList.remove('plot-hidden');
                a1.classList.add('plot-visible'); a1.classList.remove('plot-hidden');
                p2.classList.add('plot-visible'); p2.classList.remove('plot-hidden');
            }
            else if (step === 4) { plots.forEach(p => { p.classList.add('plot-visible'); p.classList.remove('plot-hidden'); }); }
            else if (step === 5) document.getElementById('step-5').classList.add('active');
            // Step 6 is handled by Layer Visibility above
            else if (step === 7) document.getElementById('step-7').classList.add('active');
            else if (step === 8) document.getElementById('step-8').classList.add('active');
        }

        // Updated updateMaterialsStepInSlide to handle -1 (nothing shown)
        function updateMaterialsStepInSlide(step) {
            const materialOrder = ['mat-LiF', 'mat-MgO', 'mat-CaO', 'mat-ZnO'];
            materialOrder.forEach((id, index) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (step === -1) {
                    el.classList.remove('active');
                    el.classList.remove('dimmed');
                } else if (index === step) {
                    el.classList.add('active');
                    el.classList.remove('dimmed');
                } else if (index < step) {
                    el.classList.add('dimmed');
                    el.classList.remove('active');
                } else {
                    el.classList.remove('active');
                    el.classList.remove('dimmed');
                }
            });
        }

        // Conclusions: appear progressively, no dimming
        function updateConclusionsStep(step) {
            const blocks = document.querySelectorAll('#slide-conclusions .conclusion-block');

            blocks.forEach((block, i) => {
                if (step === -1) {
                    block.classList.remove('active');
                } else {
                    block.classList.toggle('active', i <= step);
                }
            });
        }

        let materialsStep = -1;       // 0 = nothing shown
        const maxMaterialsStep = 4; // LiF..ZnO

        let conclusionsStep = -1;    // 0 = nothing shown
        const maxConclusionsStep = 4; // 4 blocks ‚Üí 0..3

        function nextSlide() {
            const slide = slides[currentSlide];
            const currentSlideId = slide.id;
            const { isDetail, isOverview } = getSlideContext();

            /* ---------------------------------
            SKIP / OVERVIEW (ABSOLUTE PRIORITY)
            --------------------------------- */
            if (isDetail || isOverview) {
                const targetId = slide.dataset.skipTarget;
                if (targetId) {
                    goToSlideById(targetId);
                    return;
                }
            }

            /* ---------------------------------
            SLIDE 1 (step-based)
            --------------------------------- */
            if (currentSlide === 0) {
                if (slide1Step < 8) {
                    slide1Step++;
                    updateSlide1State(slide1Step);
                    return;
                }
            }

            /* ---------------------------------
            MATERIALS SLIDE
            --------------------------------- */
            if (currentSlideId === 'slide-materials') {
                if (materialsStep < maxMaterialsStep - 1) {
                    materialsStep++;
                    updateMaterialsStepInSlide(materialsStep);
                    return;
                }
            }

            /* ---------------------------------
            CONCLUSIONS SLIDE
            --------------------------------- */
            if (currentSlideId === 'slide-conclusions') {
                if (conclusionsStep < maxConclusionsStep - 1) {
                    conclusionsStep++;
                    updateConclusionsStep(conclusionsStep);
                    return;
                }
            }


            /* ---------------------------------
            DEFAULT: NEXT SLIDE
            --------------------------------- */
            showSlide(currentSlide + 1);
        }

        function prevSlide() {
            const slide = slides[currentSlide];
            const currentSlideId = slide.id;
            const { isDetail } = getSlideContext();

            /* ---------------------------------
            BACK TARGET (ABSOLUTE PRIORITY)
            --------------------------------- */
            if (isDetail) {
                const backTarget = slide.dataset.backTarget;
                if (backTarget) {
                    goToSlideById(backTarget);
                    return;
                }
            }

            /* ---------------------------------
            MATERIALS SLIDE (BACKWARD STEPS)
            --------------------------------- */
            if (currentSlideId === 'slide-materials') {
                if (materialsStep > -1) {
                materialsStep--;
                updateMaterialsStepInSlide(materialsStep);
                return;
            } else if (materialsStep === 1) {
                    materialsStep = 0;
                    updateMaterialsStepInSlide(-1);
                    return;
                }
            }

            /* ---------------------------------
            CONCLUSIONS SLIDE (BACKWARD STEPS)
            --------------------------------- */
            if (currentSlideId === 'slide-conclusions') {
                if (conclusionsStep > 0) {
                    conclusionsStep--;
                    updateConclusionsStep(conclusionsStep);
                    return;
                } else if (conclusionsStep === 0) {
                    conclusionsStep = -1;
                    updateConclusionsStep(-1);
                    return;
                }
            }


            /* ---------------------------------
            SLIDE 1 (BACKWARD STEPS)
            --------------------------------- */
            if (currentSlide === 0) {
                if (slide1Step > 0) {
                    slide1Step--;
                    updateSlide1State(slide1Step);
                    return;
                } else if (slide1Step === 0) {
                    slide1Step = -1;
                    updateSlide1State(-1);
                    return;
                }
            }
            /* ---------------------------------
            DEFAULT: PREVIOUS SLIDE
            --------------------------------- */
            showSlide(currentSlide - 1);

        }

        function updateProgress() {
            const progress = ((currentSlide + 1) / slides.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function goToSlide(index) {
            if (index < 0 || index >= slides.length) return;
            slides[currentSlide].classList.remove("active");
            currentSlide = index;
            slides[currentSlide].classList.add("active");
        }

        function getSlideContext() {
            const slide = slides[currentSlide];

            return {
                isDetail: slide.dataset.showBack === "true",
                isOverview: slide.dataset.showSkip === "true" &&
                            slide.dataset.showBack !== "true"
            };
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'f') toggleFullScreen();
            if (e.key === "Home") goToSlide(0);
            if (e.key === "End")  goToSlide(slides.length - 1);
            });

        // Slide Jumping Mechanics
        function openDetail(targetSlideId) {
            lastOverviewSlide = currentSlide;
            goToSlideById(targetSlideId);
        }

        function goToSlideById(id) {
            const index = [...slides].findIndex(s => s.id === id);
            if (index !== -1) showSlide(index);
        }

        // Animation frames trackers
        const anims = {
            expSetup: null,
            mbDft: null,
            KS: null,
            excitation: null,
            screenE: null,
            greenE: null,
            exciton: null
        };

        const animState = {
            expSetup: null,
            mbDft: null,
            KS: null,
            excitation: null,
            screenE: null,
            greenE: null,
            exciton: null
        };

        /* --- NEW: EXPERIMENTAL SETUP ANIMATION (Slide 1) --- */
        function initExpSetupAnim() {
            const canvas = document.getElementById("experimentCanvas");
            const ctx = canvas.getContext("2d");
            const container = canvas.parentElement;

            let width, height;
            let time = 0;

            function animate() {
                if (canvas.width !== container.clientWidth) {
                    canvas.width = container.clientWidth; canvas.height = container.clientHeight;
                }
                width = canvas.width; height = canvas.height;
                const centerY = height/2;

                ctx.clearRect(0,0,width,height);

                // 1. Light Source (Beam) - Incident
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(width * 0.35, centerY); // To Sample
                ctx.strokeStyle = "#31E1F7E6"; ctx.lineWidth = 6; ctx.stroke();

                // Flowing effect
                ctx.setLineDash([10, 10]); ctx.lineDashOffset = -time; ctx.stroke(); ctx.setLineDash([]);

                // 2. Sample (The Material)
                const sampleX = width * 0.35; const sampleW = width * 0.1;
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                ctx.fillRect(sampleX, centerY - 40, sampleW, 80);
                ctx.strokeStyle = PALETTE.text; ctx.lineWidth = 2;
                ctx.strokeRect(sampleX, centerY - 40, sampleW, 80);
                ctx.fillStyle = PALETTE.text; ctx.font="20px Urbanist"; ctx.textAlign="center";
                ctx.fillText("Muestra", sampleX + sampleW/2, centerY - 50);

                // 3. Transmitted Beam (Dimmer)
                ctx.beginPath();
                ctx.moveTo(sampleX + sampleW, centerY);
                ctx.lineTo(width * 0.8, centerY); // To Detector
                ctx.strokeStyle = "#31E1F780"; // Dimmer yellow
                ctx.lineWidth = 6; ctx.stroke();
                ctx.setLineDash([10, 10]); ctx.lineDashOffset = -time; ctx.stroke(); ctx.setLineDash([]);

                // 4. Detector
                const detX = width * 0.8;
                ctx.fillStyle = "#333";
                ctx.fillRect(detX, centerY - 30, 20, 60);

                // Detector Active Light (Blinking)
                ctx.beginPath(); ctx.arc(detX + 10, centerY, 5, 0, Math.PI*2);
                const blink = Math.sin(time * 0.2) > 0 ? PALETTE.curve1 : "#333";
                ctx.fillStyle = "red"; ctx.fill();
                ctx.shadowBlur = 10; ctx.shadowColor = "red"; ctx.fill(); ctx.shadowBlur = 0;

                ctx.fillStyle = PALETTE.text; ctx.fillText("Detector", detX + 10, centerY + 50);

                time+=2;
                anims.expSetup = requestAnimationFrame(animate);
            }
            animate();
        }

        /* --- STATIC BANDS DRAWER (New Slide 1 Feature) --- */
        function drawStaticBands() {
            const canvas = document.getElementById("staticBandsCanvas");
            const ctx = canvas.getContext("2d");
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width/2;
            const vbY = height * 0.3;
            const cbY = height * 0.7;

            ctx.clearRect(0,0,width,height);

            // Draw Parabolas
            function drawPara(y0, curvature, color) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                const kMax = 400;
                for (let k = -kMax; k <= kMax; k++) {
                    const x = centerX + k;
                    const y = y0 + curvature * (k * k) / 3000;
                    if (k === -kMax) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            drawPara(cbY, +1, PALETTE.curve1); // CB
            drawPara(vbY, -1, PALETTE.curve1); // VB

            // Arrow
            ctx.beginPath(); ctx.moveTo(centerX, vbY); ctx.lineTo(centerX, cbY);
            ctx.strokeStyle = PALETTE.curve1; ctx.lineWidth = 2; ctx.stroke();
            // Arrowhead
            ctx.beginPath(); ctx.moveTo(centerX, cbY); ctx.lineTo(centerX-5, cbY-15); ctx.lineTo(centerX+5, cbY-15);
            ctx.fillStyle = PALETTE.curve1; ctx.fill();
            ctx.beginPath(); ctx.moveTo(centerX, vbY); ctx.lineTo(centerX-5, vbY+15); ctx.lineTo(centerX+5, vbY+15);
            ctx.fillStyle = PALETTE.curve1; ctx.fill();

            // Labels
            ctx.fillStyle = PALETTE.text; ctx.font="bold 20px Urbanist";
            ctx.fillText("Banda de Conducci√≥n", centerX+ 300, vbY);
            ctx.fillText("Banda de Valencia", centerX + 300, cbY);
            ctx.fillStyle = PALETTE.text;

            const gapY = (vbY + cbY) / 2;
            ctx.font = "bold 20px Urbanist";
            ctx.fillText("E", centerX + 20, gapY);
            ctx.font = "bold 16px Urbanist";
            ctx.fillText("gap", centerX + 36, gapY + 6);

        }

        /* --- 1. MANY-BODY vs DFT ANIMATION (Slide 2) --- */
        function initMbDftAnim() {
            if (animState.mbDft) return;
            animState.mbDft = true;

            const canvas = document.getElementById('mbDftCanvas');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;

            // Setup Electrons
            const electrons = [];
            for(let i=0; i<4; i++) {
                electrons.push({
                    angle: Math.random() * Math.PI * 2,
                    speed: 0.02 + Math.random() * 0.1,  // Wider spread
                    radiusX: 60 + Math.random() * 30,
                    radiusY: 50 + Math.random() * 30,
                    phase: Math.random() * Math.PI,
                    t: Math.random() * 1000  // Independent internal time
                });
            }

            let time = 0;

            function animate() {
                if (!animState.mbDft) return;

                // Resize if needed
                if (canvas.width !== container.clientWidth || canvas.height !== container.clientHeight) {
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                }
                const w = canvas.width;
                const h = canvas.height;
                const cxL = w * 0.25; // Center Left
                const cxR = w * 0.75; // Center Right
                const cy = h * 0.55;

                ctx.clearRect(0, 0, w, h);

                // --- LEFT: MANY BODY ---
                // Draw Interactions first (behind)
                ctx.beginPath();
                ctx.strokeStyle = "rgba(77, 77, 255, 1.0)";
                ctx.lineWidth = 1;

                // Calculate current positions
                const currentPos = electrons.map(e => {
                    e.t += e.speed * (0.95 + Math.random() * 0.1);

                    return {
                        x: cxL + Math.cos(e.t) * e.radiusX,
                        y: cy + Math.sin(e.t + e.phase) * Math.cos(e.t * 0.3) * e.radiusY
                    };
                });


                // Draw interaction lines between all electrons
                for(let i=0; i<currentPos.length; i++) {
                    for(let j=i+1; j<currentPos.length; j++) {
                        ctx.moveTo(currentPos[i].x, currentPos[i].y);
                        ctx.lineTo(currentPos[j].x, currentPos[j].y);
                    }
                    // Interaction to Ion
                    ctx.moveTo(currentPos[i].x, currentPos[i].y);
                    ctx.lineTo(cxL, cy);
                }
                ctx.stroke();

                // Draw Ion Left
                ctx.beginPath(); ctx.arc(cxL, cy, 20, 0, Math.PI*2);
                ctx.fillStyle = "#ff4d4d"; ctx.fill();
                ctx.fillStyle = "black"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center"; ctx.fillText("ION", cxL, cy+4);

                // Draw Electrons Left
                currentPos.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2);
                    ctx.fillStyle = "#4d4dff"; ctx.fill();
                    ctx.fillStyle = "white"; ctx.fillText("e-", p.x, p.y+4);
                });

                // Label Left
                ctx.fillStyle = PALETTE.text; ctx.font = "20px Urbanist"; ctx.fillText("Muchos Cuerpos", cxL, h - 30);


                // --- TRANSITION ARROW ---
                ctx.beginPath();
                ctx.moveTo(w*0.45, cy); ctx.lineTo(w*0.55, cy);
                ctx.strokeStyle = PALETTE.arrow; ctx.lineWidth = 4; ctx.stroke();
                // Arrowhead
                ctx.beginPath(); ctx.moveTo(w*0.55, cy); ctx.lineTo(w*0.53, cy-10); ctx.lineTo(w*0.53, cy+10);
                ctx.fillStyle = PALETTE.arrow; ctx.fill();


                // --- RIGHT: DFT ---
                // Draw Electron Cloud
                const cloudRadius = 70 + Math.sin(time * 0.05) * 5;
                const grad = ctx.createRadialGradient(cxR, cy, 10, cxR, cy, cloudRadius);
                grad.addColorStop(0, "rgba(77, 77, 255, 0.8)");
                grad.addColorStop(1, "rgba(77, 77, 255, 0)");

                ctx.beginPath(); ctx.arc(cxR, cy, cloudRadius, 0, Math.PI*2);
                ctx.fillStyle = grad; ctx.fill();

                // Draw Ion Right
                ctx.beginPath(); ctx.arc(cxR, cy, 20, 0, Math.PI*2);
                ctx.fillStyle = "#ff4d4d"; ctx.fill();
                ctx.fillStyle = "black"; ctx.font = "bold 12px Arial"; ctx.fillText("ION", cxR, cy+4);

                // Label Right
                ctx.fillStyle = PALETTE.text; ctx.font = "20px Urbanist"; ctx.fillText("DFT", cxR, h - 30);
                ctx.fillStyle = PALETTE.text; ctx.font = "17px Arial"; ctx.fillText("Densidad", cxR, cy - cloudRadius - 20);
                ctx.fillStyle = PALETTE.text; ctx.font = "17px Arial"; ctx.fillText("electr√≥nica", cxR, cy - cloudRadius - 0);

                time++;
                anims.mbDft = requestAnimationFrame(animate);
            }
            animate();
        }

        function stopMbDftAnim() {
            animState.mbDft = false;
            if (anims.mbDft) cancelAnimationFrame(anims.mbDft);
        }

        /* --- 2. MANY-BODY vs KOHN-SHAM ANIMATION (Slide ?) --- */
        function initKSAnim() {
            if (animState.KS) return;
            animState.KS = true;

            let initialized = false;
            const canvas = document.getElementById('KSCanvas');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;

            const numElectrons = 7;
            const kRepulsion = 100.2;   // MUCH stronger repulsion
            const minDist = 20;
            const damping = 1;  // Almost no artificial friction

            const electronsLeft = [];
            const electronsRight = [];

            function createElectron(index) {
                const row = Math.floor(index / 4);
                const col = index % 4;

                const spacing = 30;

                return {
                    x: col * spacing,
                    y: row * spacing,
                    vx: (index % 2 === 0 ? 5.2/(index+3) : -5.2/(index+3)),   // EVEN vs ODD
                    vy: (index % 2 === 0 ? 5.9/(index+3) : -5.9/(index+3)),
                };
            }

            for(let i=0; i<numElectrons; i++) {
                electronsLeft.push(createElectron(i));
                electronsRight.push(createElectron(i));
            }

            function updatePos(e, width, height, offsetX) {
                e.x += e.vx;
                e.y += e.vy;

                // Bounce box
                const boxW = width * 0.35;
                const boxH = height * 0.7;
                const left = offsetX - boxW/2;
                const right = offsetX + boxW/2;
                const top = height/2 - boxH/2;
                const bottom = height/2 + boxH/2;

                if(e.x < left || e.x > right) e.vx *= -1;
                if(e.y < top || e.y > bottom) e.vy *= -1;

                // Clamp
                e.x = Math.max(left, Math.min(right, e.x));
                e.y = Math.max(top, Math.min(bottom, e.y));
            }

            function applyRepulsion(electrons) {
                for (let i = 0; i < electrons.length; i++) {
                    for (let j = i + 1; j < electrons.length; j++) {
                        const e1 = electrons[i];
                        const e2 = electrons[j];

                        let dx = e1.x - e2.x;
                        let dy = e1.y - e2.y;

                        let r2 = dx*dx + dy*dy;
                        let r = Math.sqrt(r2);

                        if (r < 1) r = 1;
                        if (r < 100) {   // interaction cutoff
                            const f = kRepulsion / (r2 + minDist*minDist);

                            const fx = f * dx / r;
                            const fy = f * dy / r;

                            e1.vx += fx;
                            e1.vy += fy;
                            e2.vx -= fx;
                            e2.vy -= fy;
                        }
                    }
                }

                // Light damping
                electrons.forEach(e => {
                    e.vx *= damping;
                    e.vy *= damping;
                });
            }

            function animate() {
                if (!animState.KS) return;

                if (canvas.width !== container.clientWidth || canvas.height !== container.clientHeight) {
                    canvas.width = container.clientWidth; canvas.height = container.clientHeight;
                }
                const w = canvas.width;
                const h = canvas.height;
                const cxL = w * 0.25;
                const cxR = w * 0.75;

                // Init positions if first frame
                if (!initialized) {
                    electronsLeft.forEach(e => {
                        e.x = cxL + (Math.random() - 0.5) * 120;
                        e.y = h/2 + (Math.random() - 0.5) * 120;
                    });

                    electronsRight.forEach(e => {
                        e.x = cxR + (Math.random() - 0.5) * 120;
                        e.y = h/2 + (Math.random() - 0.5) * 120;
                    });

                    initialized = true;
                }


                ctx.clearRect(0, 0, w, h);

                // --- LEFT: INTERACTING ---
                applyRepulsion(electronsLeft);
                electronsLeft.forEach(e => updatePos(e, w, h, cxL));

                // Draw Interactions
                ctx.beginPath();
                ctx.strokeStyle = PALETTE.interaction;
                ctx.lineWidth = 2;
                for(let i=0; i<electronsLeft.length; i++) {
                    for(let j=i+1; j<electronsLeft.length; j++) {
                        const dx = electronsLeft[i].x - electronsLeft[j].x;
                        const dy = electronsLeft[i].y - electronsLeft[j].y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if(dist < 80) { // Interaction threshold
                            ctx.moveTo(electronsLeft[i].x, electronsLeft[i].y);
                            ctx.lineTo(electronsLeft[j].x, electronsLeft[j].y);
                        }
                    }
                }
                ctx.stroke();

                // Draw Electrons Left
                electronsLeft.forEach(e => {
                    ctx.beginPath(); ctx.arc(e.x, e.y, 6, 0, Math.PI*2);
                    ctx.fillStyle = PALETTE.electron; ctx.fill();
                });

                // Labels
                ctx.fillStyle = PALETTE.text;
                ctx.textAlign = "center";
                ctx.font = "20px Urbanist";
                ctx.fillText("Sistema Interactuante", cxL, h - 30);


                // --- ARROW ---
                ctx.beginPath(); ctx.moveTo(w*0.45, h/2); ctx.lineTo(w*0.53, h/2); ctx.strokeStyle = PALETTE.arrow; ctx.lineWidth = 4; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(w*0.55, h/2); ctx.lineTo(w*0.53, h/2-10); ctx.lineTo(w*0.53, h/2+10); ctx.fillStyle = PALETTE.arrow; ctx.fill();


                // --- RIGHT: KOHN-SHAM (NON-INTERACTING) ---
                electronsRight.forEach(e => updatePos(e, w, h, cxR));

                electronsRight.forEach(e => {
                    ctx.beginPath(); ctx.arc(e.x, e.y, 6, 0, Math.PI*2);
                    ctx.fillStyle = PALETTE.ion; ctx.fill();
                });

                // Label
                ctx.fillStyle = PALETTE.text;
                ctx.fillText("Sistema Kohn-Sham", cxR, h - 30);

                anims.KS = requestAnimationFrame(animate);
            }
            animate();
        }

        function stopKSAnim() {
            animState.KS = false;
            if (anims.KS) cancelAnimationFrame(anims.KS);
        }

        function drawBandgapFigure() {
            const canvas = document.getElementById("bandgapCanvas");
            const ctx = canvas.getContext("2d");

            const W = canvas.width;
            const H = canvas.height;

            ctx.clearRect(0, 0, W, H);
            ctx.strokeStyle = PALETTE.text;
            ctx.fillStyle = PALETTE.text;
            ctx.lineWidth = 2;
            ctx.font = "20px Urbanist";

            // --- Coordinate mapping ---
            function X(x) { return W * (0.40 + x * 0.07); }
            function Y(y) { return H * (0.9 - y * 0.14); }

            // --- Axes N ---
            drawArrow(X(-5), Y(0), X(0), Y(0));   // k
            drawArrow(X(-5), Y(0), X(-5), Y(5.5)); // E

            ctx.fillText("k", X(0) + 5, Y(0) + 5);
            ctx.fillText("E", X(-5) - 10, Y(5.5) - 5);
            ctx.fillText("N electrones", X(-2.5) - 5, Y(0) + 20);

            // --- Axes N+1 ---
            drawArrow(X(3), Y(0), X(8), Y(0));
            drawArrow(X(3), Y(0), X(3), Y(5.5));

            ctx.fillText("k", X(8) + 5, Y(0) + 5);
            ctx.fillText("E", X(3) - 10, Y(5.5) - 5);
            ctx.fillText("N + 1 electrones", X(5.5) - 10, Y(0) + 20);

            // --- Parabolas N ---
            drawParabola(x => 2.4 - 0.38 * (x + 2.5) ** 2, -5, 0);
            drawParabola(x => 3.7 + 0.20 * (x + 2.5) ** 2, -5, 0);

            // --- Parabolas N+1 ---
            drawParabola(x => 3.0 - 0.40 * (x - 5.5) ** 2, 3, 8);
            drawParabola(x => 4.5 + 0.25 * (x - 5.5) ** 2, 3, 8);

            // --- Key points ---
            const VBM1 = { x: -2.5, y: 2.4 };
            const CBM1 = { x: -2.5, y: 3.7 };
            const VBM2 = { x: 5.5, y: 3.0 };
            const CBM2 = { x: 5.5, y: 4.5 };

            // --- ŒîŒµ arrow ---
            drawDoubleArrow(X(VBM1.x), Y(VBM1.y), X(CBM1.x), Y(CBM1.y));
            ctx.font = "20px Urbanist";
            ctx.fillText("ŒîŒµ", X(VBM1.x) - 35, (Y(VBM1.y) + Y(CBM1.y)) / 2);

            // --- Dashed guides ---
            drawDashed(X(VBM1.x), Y(VBM1.y), X(VBM1.x + 4), Y(VBM1.y));
            drawDashed(X(CBM1.x), Y(CBM1.y), X(CBM1.x + 4), Y(CBM1.y));
            drawDashed(X(CBM2.x), Y(CBM2.y), X(CBM2.x - 4.5), Y(CBM2.y));

            // --- Œîxc arrow ---
            drawDoubleArrow(
                X(CBM1.x + 3.5), Y(CBM1.y),
                X(CBM2.x - 4.5), Y(CBM2.y)
            );
            ctx.font = "20px Urbanist";
            ctx.fillText("Œî", X(CBM1.x + 2.6), (Y(CBM1.y) + Y(CBM2.y)) / 2);
            ctx.font = "12px Urbanist";
            ctx.fillText("XC", X(CBM1.x + 2.9), (Y(CBM1.y) + Y(CBM2.y)) / 2 + 3);

            // --- Egap arrow ---
            drawDoubleArrow(
                X(VBM1.x + 4), Y(VBM1.y),
                X(CBM2.x - 4), Y(CBM2.y)
            );
            ctx.font = "20px Urbanist";
            ctx.fillText("E", X(VBM1.x + 4.2), (Y(VBM1.y) + Y(CBM2.y)) / 2);
            ctx.font = "12px Urbanist";
            ctx.fillText("gap", X(VBM1.x + 4.5), (Y(VBM1.y) + Y(CBM2.y)) / 2 + 3);

            // ========== Helper Functions ==========

            function drawArrow(x1, y1, x2, y2) {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                const a = Math.atan2(y2 - y1, x2 - x1);
                const L = 10;

                ctx.beginPath();
                ctx.moveTo(x2, y2);
                ctx.lineTo(x2 - L * Math.cos(a - 0.3), y2 - L * Math.sin(a - 0.3));
                ctx.lineTo(x2 - L * Math.cos(a + 0.3), y2 - L * Math.sin(a + 0.3));
                ctx.fill();
            }

            function drawDoubleArrow(x1, y1, x2, y2) {
                drawArrow(x1, y1, x2, y2);
                drawArrow(x2, y2, x1, y1);
            }

            function drawDashed(x1, y1, x2, y2) {
                ctx.setLineDash([6, 5]);
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            function drawParabola(f, xmin, xmax) {
                ctx.beginPath();
                ctx.strokeStyle = PALETTE.curve1;
                let first = true;
                for (let x = xmin; x <= xmax; x += 0.02) {
                    const px = X(x);
                    const py = Y(f(x));
                    if (first) {
                        ctx.moveTo(px, py);
                        first = false;
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                ctx.stroke();
                ctx.strokeStyle = PALETTE.text;
            }
        }
        drawBandgapFigure();

        /* --- NEW: GREEN'S FUNCTION ANIMATION (Electron forward, Hole backward) --- */
        function initGreensAnim() {
            if (animState.greens) return;
            animState.greens = true;

            const cE = document.getElementById('greenElectronCanvas');
            const cH = document.getElementById('greenHoleCanvas');
            const ctxE = cE.getContext('2d');
            const ctxH = cH.getContext('2d');
            const contE = cE.parentElement;
            const contH = cH.parentElement;

            let w, h, time = 0;

            // Trails
            let eTrail = [];
            let hTrail = [];
            const MAX_TRAIL = 40;

            // Matching exciton style
            function drawElectronStyle(ctx, x, y) {
                const grad = ctx.createRadialGradient(x, y, 2, x, y, 15);
                grad.addColorStop(0, '#ffffff');
                grad.addColorStop(0.4, PALETTE.curve1);
                grad.addColorStop(1, 'rgba(222,255,154,0)');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();
            }

            function drawHoleStyle(ctx, x, y) {
                ctx.strokeStyle = PALETTE.curve1;
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = '#000';
                ctx.fill();
            }

            function drawTrail(ctx, trailArray, color) {
                if (trailArray.length < 2) return;
                ctx.setLineDash([5,5]);
                ctx.lineWidth = 2;

                for (let i = 1; i < trailArray.length; i++) {
                    const p1 = trailArray[i-1];
                    const p2 = trailArray[i];
                    const alpha = i / trailArray.length * 0.6; // fade out

                    ctx.strokeStyle = `rgba(${color.r},${color.g},${color.b}, ${alpha})`;
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
                ctx.setLineDash([]);
            }

            function animate() {
                if (!animState.greens) return;

                // Resize if needed
                if (cE.width !== contE.clientWidth) {
                    cE.width = contE.clientWidth;
                    cE.height = contE.clientHeight;
                    cH.width = contH.clientWidth;
                    cH.height = contH.clientHeight;
                }

                w = cE.width;
                h = cE.height;
                const yCenter = h/2;

                ctxE.clearRect(0,0,w,h);
                ctxH.clearRect(0,0,w,h);

                // Time axis + arrowhead
                [ctxE, ctxH].forEach(ctx => {
                    ctx.beginPath();
                    ctx.moveTo(20, yCenter);
                    ctx.lineTo(w-30, yCenter);
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Arrowhead
                    ctx.beginPath();
                    ctx.moveTo(w-30, yCenter - 6);
                    ctx.lineTo(w-20, yCenter);
                    ctx.lineTo(w-30, yCenter + 6);
                    ctx.stroke();

                    ctx.fillStyle = "white";
                    ctx.font = "bold 15px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText("t", w-30, yCenter + 30);
                });

                // Motion parameters
                const loop = time % 300;
                const startX = 40;
                const endX = w - 40;

                // *** FIXED: Separate progress for electron and hole ***
                const eProgress = (loop - 20) / 100;
                const hProgress = (loop - 160) / 100;

                /* ------------------------------
                ELECTRON: forward in time
                ------------------------------ */

                // Creation flash
                if (loop >= 15 && loop < 25) {
                    const R = (loop - 15) * 3;
                    ctxE.beginPath();
                    ctxE.arc(startX, yCenter, R, 0, 2*Math.PI);
                    ctxE.strokeStyle = PALETTE.curve1;
                    ctxE.lineWidth = 2;
                    ctxE.stroke();
                }

                // Motion
                if (loop >= 20 && loop <= 120) {
                    const x = startX + (endX - startX) * eProgress;
                    const y = yCenter
                        + Math.sin(eProgress * 13) * 12
                        + Math.cos(eProgress * 31) * 6
                        + Math.cos(eProgress * 19) * 15;

                    // Update trail
                    eTrail.push({x, y});
                    if (eTrail.length > MAX_TRAIL) eTrail.shift();

                    // Draw
                    drawTrail(ctxE, eTrail, {r:117,g:201,b:104});
                    drawElectronStyle(ctxE, x, y);
                } else {
                    eTrail = [];
                }

                // Annihilation flash
                if (loop >= 120 && loop < 140) {
                    const R = (loop - 120) * 4;
                    ctxE.beginPath();
                    ctxE.arc(endX, yCenter, R, 0, 2*Math.PI);
                    ctxE.strokeStyle = PALETTE.curve1;
                    ctxE.lineWidth = 2;
                    ctxE.stroke();
                }

                /* ------------------------------
                HOLE: backward in time
                ------------------------------ */

                // Creation flash ‚Äî FIXED R
                if (loop >= 155 && loop < 165) {
                    const R = (loop - 155) * 3;
                    ctxH.beginPath();
                    ctxH.arc(endX, yCenter, R, 0, 2*Math.PI);
                    ctxH.strokeStyle = "white";
                    ctxH.lineWidth = 2;
                    ctxH.stroke();
                }

                // Motion ‚Äî FIXED progress
                if (loop >= 160 && loop <= 260) {
                    const x = endX - (endX - startX) * hProgress;
                    const y = yCenter
                        + Math.sin(eProgress * 13) * 12
                        - Math.cos(eProgress * 31) * 6
                        + Math.cos(eProgress * 19) * 15;

                    hTrail.push({x, y});
                    if (hTrail.length > MAX_TRAIL) hTrail.shift();

                    drawTrail(ctxH, hTrail, {r:117,g:201,b:104});
                    drawHoleStyle(ctxH, x, y);
                } else {
                    hTrail = [];
                }

                // Annihilation flash ‚Äî FIXED condition + radii
                if (loop >= 260 && loop < 280) {
                    const R = (loop - 260) * 4;

                    // hole annihilation at start
                    ctxH.beginPath();
                    ctxH.arc(startX, yCenter, R, 0, 2*Math.PI);
                    ctxH.strokeStyle = "white";
                    ctxH.lineWidth = 2;
                    ctxH.stroke();
                }

                time++;
                anims.greenE = requestAnimationFrame(animate);
            }

            animate();
        }

        function stopGreensAnim() {
            animState.greens = false;
            if (anims.greenE) cancelAnimationFrame(anims.greenE);
        }

        /* --- ANIMATION 2: GW SCREENING (ELECTRON ONLY) --- */
        function initScreeningBox(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;

            // Physics State
            const ions = [];
            const electrons = [];
            const mouse = { x: -1000, y: -1000 };
            const rows = 5;
            const cols = 15;
            const spacing = 40;

            // Init Grid
            function initGrid() {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;

                ions.length = 0;
                electrons.length = 0;

                const startX = (canvas.width - (cols - 1) * spacing) / 2;
                const startY = (canvas.height - (rows - 1) * spacing) / 2;

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const x = startX + c * spacing;
                        const y = startY + r * spacing;

                        ions.push({ x, y });

                        electrons.push({
                            originX: x,
                            originY: y,
                            x: x,
                            y: y,
                            vx: 0,
                            vy: 0
                        });
                    }
                }
            }
            initGrid();

            // Mouse Tracker
            container.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouse.x = e.clientX - rect.left;
                mouse.y = e.clientY - rect.top;
            });

            container.addEventListener('mouseleave', () => {
                mouse.x = -1000;
                mouse.y = -1000;
            });

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // --- 1. Draw Fixed Ions ---
                ctx.fillStyle = PALETTE.ion;
                ions.forEach(ion => {
                    ctx.beginPath();
                    ctx.arc(ion.x, ion.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                // --- 2. Physics & Draw Background Electrons ---
                ctx.fillStyle = PALETTE.electron;

                electrons.forEach(e => {
                    // Spring force to lattice site
                    const k = 0.05;
                    let fx = (e.originX - e.x) * k;
                    let fy = (e.originY - e.y) * k;

                    // Repulsive Coulomb from extra electron (mouse)
                    const dx = e.x - mouse.x;
                    const dy = e.y - mouse.y;
                    const distSq = dx * dx + dy * dy;
                    const dist = Math.sqrt(distSq);

                    if (dist < 200) {
                        const forceMag = 1500 / (distSq + 400); // softened Coulomb
                        fx += (dx / dist) * forceMag;
                        fy += (dy / dist) * forceMag;
                    }

                    // Integration with damping
                    e.vx = (e.vx + fx) * 0.85;
                    e.vy = (e.vy + fy) * 0.85;
                    e.x += e.vx;
                    e.y += e.vy;

                    // Draw electron
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });

                // --- 3. Draw Extra Electron (Mouse Probe) ---
                if (mouse.x > 0) {
                    ctx.beginPath();
                    ctx.arc(mouse.x, mouse.y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = PALETTE.electron;
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = PALETTE.electron;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }

                anims.screenE = requestAnimationFrame(animate);
            }

            animate();

            // Handle Resize
            window.addEventListener('resize', initGrid);
        }

        function loadMultiFilePlot(divId, curveSpecs, options = {}) {

            const {
                xlim = null,
                ylim = null,
                xlabel = "",
                ylabel = "",
                title = "",
                showTicks = false
            } = options;

            // --- CHANGE 1: Remove Promise.all/fetch and map directly ---
            const datasets = curveSpecs.map(spec => {
                return {
                    spec: spec,
                    // Access the data object you passed (e.g., LiF_optical_EXC_data)
                    x: spec.data.x,
                    y: spec.data.y
                };
            });

            // --- CHANGE 2: The rest of the code is identical, just no longer inside .then() ---

            // font scaling remains unchanged
            function adaptiveFont(container) {
                const h = container.clientHeight;
                const w = container.clientWidth;
                const base = Math.min(w, h);

                return {
                    title: Math.max(12, base * 0.05),
                    label: Math.max(10, base * 0.04),
                    ticks: Math.max(10, base * 0.04),
                    legend: Math.max(10, base * 0.04)
                };
            }

            const container = document.getElementById(divId);
            if (!container) return; // Safety check

            const fonts = adaptiveFont(container);

            const allX = datasets.flatMap(d => d.x);
            const allY = datasets.flatMap(d => d.y);
            const dataMinX = Math.min(...allX);
            const dataMaxX = Math.max(...allX);
            const dataMinY = Math.min(...allY);
            const dataMaxY = Math.max(...allY);
            const y_eps = 0.2;

            const traces = [];

            datasets.forEach(({ spec, x, y }) => {
                let trace;

                if (spec.mode === "impulse") {
                    const xi = [], yi = [];
                    for (let i = 0; i < x.length; i++) {
                        xi.push(x[i], x[i], NaN);
                        yi.push(0, y[i], NaN);
                    }
                    trace = {
                        x: xi,
                        y: yi,
                        mode: "lines",
                        name: spec.name,
                        line: { width: 1, color: spec.color },
                        hoverinfo: "skip",
                        connectgaps: false
                    };
                } else if (spec.mode === "line") {
                    trace = {
                        x, y,
                        mode: "lines",
                        name: spec.name,
                        line: { width: 2, color: spec.color }
                    };
                } else if (spec.mode === "markers") {
                    trace = {
                        x, y,
                        mode: "markers",
                        name: spec.name,
                        marker: { size: 6, color: spec.color }
                    };
                } else if (spec.mode === "line+markers") {
                    trace = {
                        x, y,
                        mode: "lines+markers",
                        name: spec.name,
                        line: { width: 2, color: spec.color },
                        marker: { size: 6, color: spec.color }
                    };
                }

                traces.push(trace);
            });

            // ----------- correct axis positions -----------
            const xmin = xlim ? xlim[0] : dataMinX;
            const xmax = xlim ? xlim[1] : dataMaxX;
            const ymin = ylim ? ylim[0] : Math.min(0, dataMinY);
            const ymax = ylim ? ylim[1] : dataMaxY + y_eps;

            // ----------- shapes array building ------------
            const shapes = [
                // horizontal axis at y=0
                {
                    type: "line",
                    x0: xmin,
                    x1: xmax,
                    y0: 0,
                    y1: 0,
                    line: { width: 2, color: "white" }
                },
                // vertical axis at min-X
                {
                    type: "line",
                    x0: xmin,
                    x1: xmin,
                    y0: ymin,
                    y1: ymax,
                    line: { width: 2, color: "white" }
                }
            ];

            // ----------- add per-curve vertical dashed line ----------------
            datasets.forEach(({ spec }) => {
                if (spec.xline !== undefined && !isNaN(spec.xline)) {
                    shapes.push({
                        type: "line",
                        x0: spec.xline, x1: spec.xline, y0: ymin, y1: ymax,
                        line: {
                            width: 1,
                            dash: "dash",
                            color: PALETTE.text
                        }
                    });
                }
            });

            // --- layout ---
            const layout = {
                margin: { l: 80, r: 14, t: 50, b: 80 },

                paper_bgcolor: "#111",
                plot_bgcolor: "#111",
                font: { color: "white" }, // Replaced PALETTE.text

                annotations: title ? [
                    {
                        x: 1.00,
                        y: 1.03,
                        xref: "paper",
                        yref: "paper",
                        text: title,
                        showarrow: false,
                        xanchor: "right",
                        yanchor: "bottom",
                        align: "right",
                        font: {
                            size: fonts.title,
                            color: PALETTE.text
                        }
                    }
                ] : [],

                xaxis: {
                    title: xlabel,
                    titlefont: { size: fonts.label },
                    tickfont: { size: fonts.ticks },
                    showgrid: false,
                    zeroline: false,
                    showticklabels: showTicks,
                    range: [xmin, xmax]
                },

                yaxis: {
                    title: ylabel,
                    titlefont: { size: fonts.label },
                    tickfont: { size: fonts.ticks },
                    showgrid: false,
                    zeroline: false,
                    showticklabels: showTicks,
                    range: [ymin, ymax]
                },

                legend: {
                    font: { size: fonts.legend },
                    x: 1.00,
                    y: 0.98,
                    xanchor: "right",
                    yanchor: "top",
                    orientation: "v"
                },

                showlegend: true,

                shapes,

                autosize: true
            };

            Plotly.newPlot(divId, traces, layout, {
                displayModeBar: false,
                responsive: true
            });
        }

        window.plotSpecs = {
                // Title example
                "incident": {
                    curves: [
                        { data: incident,    mode: "line",    name: "Exp.",       color: PALETTE.curve1 }
                    ],
                    settings: { title: "", xlim: [0,1], ylim: [0, 1], xlabel: "Energ√≠a", ylabel: "Intensidad", showTicks: false }
                },
                "transmited": {
                    curves: [
                        { data: transmited,    mode: "line",    name: "Exp.",       color: PALETTE.curve1 }
                    ],
                    settings: { title: "", xlim: [0,1], ylim: [0, 1], xlabel: "Energ√≠a", ylabel: "Intensidad", showTicks: false }
                },
                "absorbed": {
                    curves: [
                        { data: absorbed,    mode: "line",    name: "Exp.",       color: PALETTE.curve1 }
                    ],
                    settings: { title: "", xlim: [0,1], ylim: [0, 1], xlabel: "Energ√≠a", ylabel: "Intensidad", showTicks: false }
                },

                // Optical Im
                "plot-optical_LiF": {
                    curves: [
                        { data: LiF_optical_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: LiF_optical_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 14.66 },
                        { data: LiF_optical_exp_Im,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "LiF  shift=0.9eV", xlim: [10, 30], ylim: [0, 9], xlabel: "Energ√≠a [eV]", ylabel: "Im(Œµ)", showTicks: true }
                },

                "plot-optical_MgO": {
                    curves: [
                        { data: MgO_optical_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: MgO_optical_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 7.99 },
                        { data: MgO_optical_exp_Im,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "MgO  shift=0.7eV", xlim: [0, 30], ylim: [0, 6], xlabel: "Energ√≠a [eV]", ylabel: "Im(Œµ)", showTicks: true }
                },

                "plot-optical_CaO": {
                    curves: [
                        { data: CaO_optical_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: CaO_optical_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 6.925 },
                        { data: CaO_optical_exp_Im,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "CaO  shift=0.8eV", xlim: [4, 15], ylim: [0, 16], xlabel: "Energ√≠a [eV]", ylabel: "Im(Œµ)", showTicks: true }
                },

                "plot-optical_ZnO_ord": {
                    curves: [
                        { data: ZnO_optical_EXC_xy,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_optical_Im_xy,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE",  color: PALETTE.curve1, xline: 3.786 },
                        { data: ZnO_optical_exp_Im_xy,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "ZnO  shift=1.0eV pol.\u22A5", xlim: [2, 20], ylim: [0, 5], xlabel: "Energ√≠a [eV]", ylabel: "Im(Œµ)", showTicks: true }
                },

                "plot-optical_ZnO_extr": {
                    curves: [
                        { data: ZnO_optical_EXC_z,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_optical_Im_z,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE",  color: PALETTE.curve1, xline: 3.786 },
                        { data: ZnO_optical_exp_Im_z,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "ZnO  shift=1.0eV pol.\u2225", xlim: [2, 20], ylim: [0, 5], xlabel: "Energ√≠a [eV]", ylabel: "Im(Œµ)", showTicks: true }
                },

                // Optical Re
                "plot-optical_LiF_Re": {
                    curves: [
                        { data: LiF_optical_Re,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 14.66 },
                        { data: LiF_optical_exp_Re,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "LiF  shift=0.9eV", xlim: [10, 30], ylim: [-3, 5], xlabel: "Energ√≠a [eV]", ylabel: "Re(Œµ)", showTicks: true }
                },

                "plot-optical_MgO_Re": {
                    curves: [
                        { data: MgO_optical_Re,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 7.99 },
                        { data: MgO_optical_exp_Re,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "MgO  shift=0.7eV", xlim: [0, 30], ylim: [-1, 8], xlabel: "Energ√≠a [eV]", ylabel: "Re(Œµ)", showTicks: true }
                },

                "plot-optical_CaO_Re": {
                    curves: [
                        { data: CaO_optical_Re,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 6.925 }
                    ],
                    settings: { title: "CaO  shift=0.8eV", xlim: [4, 15], ylim: [-2, 7], xlabel: "Energ√≠a [eV]", ylabel: "Re(Œµ)", showTicks: true }
                },

                "plot-optical_ZnO_Re_ord": {
                    curves: [
                        { data: ZnO_optical_Re_xy,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE",  color: PALETTE.curve1, xline: 3.786 },
                        { data: ZnO_optical_exp_Re_xy,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "ZnO  shift=1.0eV pol.\u22A5", xlim: [2, 20], ylim: [-2, 8.5], xlabel: "Energ√≠a [eV]", ylabel: "Re(Œµ)", showTicks: true }
                },

                "plot-optical_ZnO_Re_extr": {
                    curves: [
                        { data: ZnO_optical_Re_z,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE",  color: PALETTE.curve1, xline: 3.786 },
                        { data: ZnO_optical_exp_Re_z,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "ZnO  shift=1.0eV pol.\u2225", xlim: [2, 20], ylim: [-2, 8.5], xlabel: "Energ√≠a [eV]", ylabel: "Re(Œµ)", showTicks: true }
                },

                // XANES LiF
                "plot-XANES_LiF_Li_K": {
                    curves: [
                        { data: LiF_XANES_Li_K_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: LiF_XANES_Li_K_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 63.32 },
                        { data: LiF_XANES_Li_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: LiF_XANES_Li_K_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 }
                    ],
                    settings: { title: "Li borde-K  shift=0.2eV", xlim: [57, 74], ylim: [0, 1.4], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_LiF_F_K": {
                    curves: [
                        { data: LiF_XANES_F_K_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: LiF_XANES_F_K_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 95.16 },
                        { data: LiF_XANES_F_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "F borde-K  shift=29.1eV", xlim: [682, 705], ylim: [0, 1], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                // XANES MgO
                "plot-XANES_MgO_Mg_L23": {
                    curves: [
                        { data: MgO_XANES_Mg_L23_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: MgO_XANES_Mg_L23_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 53.06 },
                        { data: MgO_XANES_Mg_L23_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: MgO_XANES_Mg_L23_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 }
                    ],
                    settings: { title: "Mg borde-L‚ÇÇ‚ÇÉ  shift=-0.5eV", xlim: [50, 73], ylim: [0, 1.5], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_MgO_O_K": {
                    curves: [
                        { data: MgO_XANES_O_K_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: MgO_XANES_O_K_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 535.45 },
                        { data: MgO_XANES_O_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: MgO_XANES_O_K_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 }
                    ],
                    settings: { title: "O borde-K  shift=28eV", xlim: [530, 565], ylim: [0, 1], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_MgO_Mg_K": {
                    curves: [
                        { data: MgO_XANES_Mg_K_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: MgO_XANES_Mg_K_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 1307.21 },
                        { data: MgO_XANES_Mg_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: MgO_XANES_Mg_K_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 },
                        { data: MgO_XANES_Mg_K_exp3,    mode: "line",    name: "Exp.",       color: PALETTE.curve5 }
                    ],
                    settings: { title: "Mg borde-K  shift=52.5eV", xlim: [1300, 1335], ylim: [0, 1.2], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                // XANES CaO
                "plot-XANES_CaO_Ca_L23": {
                    curves: [
                        { data: CaO_XANES_Ca_L23_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: CaO_XANES_Ca_L23_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 351.16 },
                        { data: CaO_XANES_Ca_L23_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "Ca borde-L‚ÇÇ‚ÇÉ  shift=24.4eV", xlim: [345, 354], ylim: [0, 1.7], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_CaO_O_K": {
                    curves: [
                        { data: CaO_XANES_O_K_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: CaO_XANES_O_K_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 532.02 },
                        { data: CaO_XANES_O_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: CaO_XANES_O_K_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 }
                    ],
                    settings: { title: "O borde-K  shift=25.9eV", xlim: [523, 560], ylim: [0, 1.1], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_CaO_Ca_K": {
                    curves: [
                        { data: CaO_XANES_Ca_K_EXC,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: CaO_XANES_Ca_K_Im,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 4033.36 },
                        { data: CaO_XANES_Ca_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "Ca borde-K  shift=95eV", xlim: [4022, 4160], ylim: [0, 0.38], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                // XANES ZnO
                "plot-XANES_ZnO_O_K_ord": {
                    curves: [
                        { data: ZnO_XANES_O_K_EXC_xy,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_XANES_O_K_Im_xy,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 530.57 },
                        { data: ZnO_XANES_O_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: ZnO_XANES_O_K_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 }
                    ],
                    settings: { title: "O borde-K  shift=25.7eV pol.\u22A5", xlim: [526, 565], ylim: [0, 1.], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_ZnO_O_K_extr": {
                    curves: [
                        { data: ZnO_XANES_O_K_EXC_z,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_XANES_O_K_Im_z,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 530.57 },
                        { data: ZnO_XANES_O_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 },
                        { data: ZnO_XANES_O_K_exp2,    mode: "line",    name: "Exp.",       color: PALETTE.curve4 }
                    ],
                    settings: { title: "O borde-K  shift=25.7eV pol.\u2225", xlim: [526, 565], ylim: [0, 1.], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_ZnO_Zn_L23_ord": {
                    curves: [
                        { data: ZnO_XANES_Zn_L23_EXC_xy,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_XANES_Zn_L23_Im_xy,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 1022.62 },
                        { data: ZnO_XANES_Zn_L23_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "Zn borde-L‚ÇÇ‚ÇÉ  shift=31.5eV pol.\u22A5", xlim: [1018, 1082], ylim: [0, 1], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_ZnO_Zn_L23_extr": {
                    curves: [
                        { data: ZnO_XANES_Zn_L23_EXC_z,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_XANES_Zn_L23_Im_z,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 1022.62 },
                        { data: ZnO_XANES_Zn_L23_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "Zn borde-L‚ÇÇ‚ÇÉ  shift=31.5eV pol.\u2225", xlim: [1018, 1082], ylim: [0, 1], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_ZnO_Zn_K_ord": {
                    curves: [
                        { data: ZnO_XANES_Zn_K_EXC_xy,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_XANES_Zn_K_Im_xy,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 9660.09 },
                        { data: ZnO_XANES_Zn_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "Zn borde-K  shift=149.3eV pol.\u22A5", xlim: [9650, 9730], ylim: [0, 1.2], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },

                "plot-XANES_ZnO_Zn_K_extr": {
                    curves: [
                        { data: ZnO_XANES_Zn_K_EXC_z,       mode: "impulse", name: "|Osc.Str.|",  color: PALETTE.curve2 },
                        { data: ZnO_XANES_Zn_K_Im_z,        mode: "line",    name: "G‚ÇÄW‚ÇÄ + BSE", color: PALETTE.curve1, xline: 9660.09 },
                        { data: ZnO_XANES_Zn_K_exp1,    mode: "line",    name: "Exp.",       color: PALETTE.curve3 }
                    ],
                    settings: { title: "Zn borde-K  shift=149.3eV pol.\u2225", xlim: [9650, 9730], ylim: [0, 1.2], xlabel: "Energ√≠a [eV]", ylabel: "Intensidad [u. arb.]", showTicks: true }
                },


            };

        /* -----------------------------------------
        LIST ITEM POPUPS (Materials + Conclusions)
        ----------------------------------------- */

        document.querySelectorAll('.material-block li, .conclusion-block li').forEach(li => {
            li.addEventListener('mouseenter', () => {

                // Only show popup if parent block is visible
                const block = li.closest('.material-block, .conclusion-block');
                if (!block || !block.classList.contains('active')) return;

                const content = li.getAttribute('data-popup');
                if (!content) return;

                const popupDiv = document.createElement('div');
                popupDiv.className = 'material-popup';
                popupDiv.textContent = content;
                document.body.appendChild(popupDiv);

                const rect = li.getBoundingClientRect();

                let left = rect.right + 10 + window.scrollX;
                let top  = rect.top + window.scrollY + rect.height / 2;

                // Prevent overflow ‚Üí move left if needed
                if (left + popupDiv.offsetWidth > window.innerWidth) {
                    left = rect.left - popupDiv.offsetWidth - 10 + window.scrollX;
                }

                popupDiv.style.left = left + 'px';
                popupDiv.style.top  = (top - popupDiv.offsetHeight / 2) + 'px';

                popupDiv.classList.add('show');
                li._popupDiv = popupDiv;
            });

            li.addEventListener('mouseleave', () => {
                if (li._popupDiv) {
                    li._popupDiv.remove();
                    li._popupDiv = null;
                }
            });
        });

        /* --- 4. EXCITATION ANIMATION (Slide ?? - Parabolic) --- */
        const exCanvas = document.getElementById('excitationCanvas');
        const exCtx = exCanvas.getContext('2d');
        let width, height, exTime=0, phase='incoming', photonX=-100, electronY=0, electronX=0;
        const bands = { vbTop: 0, cbBottom: 0, centerX: 0 };

        function resizeExcitation() {
            const wrapper = exCanvas.parentElement;
            if(!wrapper) return;
            width = exCanvas.width = wrapper.clientWidth; height = exCanvas.height = wrapper.clientHeight;
            bands.vbTop = height * 0.7; bands.cbBottom = height * 0.3; bands.centerX = width / 2;
            if (phase === 'incoming') { electronY = bands.vbTop; electronX = bands.centerX; }
            animateExcitation();
        }

        function drawParabolicBands() {
            exCtx.strokeStyle = PALETTE.curve1; exCtx.lineWidth = 3;
            const kMax = 400;

            // CB (Up)
            exCtx.beginPath();
            for (let k = -kMax; k <= kMax; k++) {
                const x = bands.centerX + k;
                const y = bands.cbBottom - (k*k)/2500;
                if (k === -kMax) exCtx.moveTo(x, y); else exCtx.lineTo(x, y);
            }
            exCtx.stroke();

            // VB (Down)
            exCtx.beginPath();
            for (let k = -kMax; k <= kMax; k++) {
                const x = bands.centerX + k;
                const y = bands.vbTop + (k*k)/2500;
                if (k === -kMax) exCtx.moveTo(x, y); else exCtx.lineTo(x, y);
            }
            exCtx.stroke();
        }

        function drawPhoton(x, y) {
            exCtx.beginPath(); exCtx.strokeStyle = PALETTE.curve1; exCtx.lineWidth = 3;
            for (let i = 0; i < 80; i++) {
                const px = x - i; const py = y + Math.sin((x - i) * 0.2 - exTime * 0.2) * 8;
                if (i === 0) exCtx.moveTo(px, py); else exCtx.lineTo(px, py);
            }
            exCtx.stroke(); exCtx.fillStyle = PALETTE.curve1; exCtx.beginPath();
            exCtx.arc(x, y + Math.sin(x * 0.2 - exTime * 0.2) * 8, 3, 0, Math.PI*2); exCtx.fill();
        }

        function drawElectron(x, y) {
            const grad = exCtx.createRadialGradient(x, y, 2, x, y, 15);
            grad.addColorStop(0, '#ffffff'); grad.addColorStop(0.4, PALETTE.curve1); grad.addColorStop(1, 'rgba(222, 255, 154, 0)');
            exCtx.fillStyle = grad; exCtx.beginPath(); exCtx.arc(x, y, 15, 0, Math.PI*2); exCtx.fill();
            exCtx.fillStyle = '#fff'; exCtx.beginPath(); exCtx.arc(x, y, 4, 0, Math.PI*2); exCtx.fill();
        }

        function drawHole(x, y) {
            exCtx.strokeStyle = PALETTE.curve1; exCtx.lineWidth = 2;
            exCtx.beginPath(); exCtx.arc(x, y, 8, 0, Math.PI*2); exCtx.stroke();
            exCtx.fillStyle = '#000'; exCtx.fill();
            //exCtx.beginPath(); exCtx.moveTo(x-4, y); exCtx.lineTo(x+4, y); exCtx.moveTo(x, y-4); exCtx.lineTo(x, y+4); exCtx.stroke();
        }

        function drawInteraction(ex, ey, hx, hy) {
            exCtx.setLineDash([5, 5]); exCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            exCtx.beginPath(); exCtx.moveTo(ex, ey); exCtx.lineTo(hx, hy); exCtx.stroke(); exCtx.setLineDash([]);
        }

        function animateExcitation() {
            exCtx.clearRect(0, 0, width, height); drawParabolicBands();

            // Positions
            const targetY = bands.cbBottom + 0; // Slightly above bottom for visual
            const startY = bands.vbTop - 0;     // Slightly below top

            if (phase === 'incoming') {
                drawElectron(electronX, startY); photonX += 6; drawPhoton(photonX, startY);
                if (photonX >= electronX) phase = 'transition';
            } else if (phase === 'transition') {
                drawHole(electronX, startY); const speed = (electronY - targetY) * 0.08;
                electronY -= Math.max(speed, 1.0); drawElectron(electronX, electronY);
                if (electronY <= targetY) { electronY = targetY; phase = 'bound'; }
            } else if (phase === 'bound') {
                drawHole(electronX, startY); drawElectron(electronX, targetY + Math.sin(exTime*0.05)*3);
                drawInteraction(electronX, targetY, electronX, startY);
                exCtx.fillStyle = PALETTE.text; exCtx.font = 'bold 20px Urbanist'; exCtx.textAlign = 'center';
                exCtx.fillText("Excit√≥n", bands.centerX + 100, height/2 ); exCtx.textAlign = 'left';
            }
            exTime++;
            anims.excitation = requestAnimationFrame(animateExcitation);
        }

        function resetAnim() {
            if(anims.excitation) cancelAnimationFrame(anims.excitation);
            phase = 'incoming'; photonX = -100; resizeExcitation();
        }

        /* --- 5. EXCITONS type --- */
        function init_excitons() {

            // Safety check to prevent animation buildup
            if (window.anims) {
                if (window.anims.frenkel) cancelAnimationFrame(window.anims.frenkel);
                if (window.anims.wannier) cancelAnimationFrame(window.anims.wannier);
            } else {
                window.anims = {};
            }

            function initFrenkel() {
                const canvas = document.getElementById('frenkelCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let width, height;
                let time = 0;

                const rows = 7, cols = 7;

                function resize() {
                    width = canvas.width = canvas.parentElement.clientWidth;
                    height = canvas.height = canvas.parentElement.clientHeight;
                }
                window.addEventListener('resize', resize);
                resize();

                function animate() {
                    ctx.clearRect(0, 0, width, height);

                    const spacing = width / (cols + 1);
                    const startX = spacing;
                    const startY = height / 2 - ((rows - 1) * spacing) / 2;

                    // Draw Lattice
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const x = startX + c * spacing;
                            const y = startY + r * spacing;

                            ctx.beginPath();
                            ctx.arc(x, y, 6, 0, Math.PI * 2);
                            ctx.fillStyle = PALETTE.lattice;
                            ctx.fill();
                        }
                    }

                    // Exciton Center (Snapped to lattice point [3,3])
                    // Using integer '3' instead of '3.5' puts it exactly on the atom
                    const centerCol = 3;
                    const centerRow = 3;
                    const cx = startX + centerCol * spacing;
                    const cy = startY + centerRow * spacing;

                    // Hole
                    ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI * 2);
                    ctx.fillStyle = PALETTE.ion;
                    ctx.shadowBlur = 10; ctx.shadowColor = PALETTE.ion;
                    ctx.fill(); ctx.shadowBlur = 0;

                    // Electron (Tight Orbit)
                    const radius = 18;
                    const ex = cx + Math.cos(time * 0.1) * radius;
                    const ey = cy + Math.sin(time * 0.1) * radius;

                    // Wavefunction Cloud
                    const grad = ctx.createRadialGradient(cx, cy, 5, cx, cy, radius + 15);
                    grad.addColorStop(0, "rgba(77, 77, 255, 0.0)");
                    grad.addColorStop(0.6, "rgba(77, 77, 255, 0.2)");
                    grad.addColorStop(1, "rgba(77, 77, 255, 0)");

                    ctx.beginPath(); ctx.arc(cx, cy, radius + 15, 0, Math.PI * 2);
                    ctx.fillStyle = grad; ctx.fill();

                    // Electron Particle
                    ctx.beginPath(); ctx.arc(ex, ey, 6, 0, Math.PI * 2);
                    ctx.fillStyle = PALETTE.electron; ctx.fill();

                    // Connection
                    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(ex, ey);
                    ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.setLineDash([2, 2]); ctx.stroke(); ctx.setLineDash([]);

                    time++;
                    window.anims.frenkel = requestAnimationFrame(animate);
                }
                animate();
            }

            function initWannier() {
                const canvas = document.getElementById('wannierCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let width, height;
                let time = 0;

                const rows = 7, cols = 7;

                function resize() {
                    width = canvas.width = canvas.parentElement.clientWidth;
                    height = canvas.height = canvas.parentElement.clientHeight;
                }
                window.addEventListener('resize', resize);
                resize();

                function animate() {
                    ctx.clearRect(0, 0, width, height);

                    const spacing = width / (cols + 1);
                    const startX = spacing;
                    const startY = height / 2 - ((rows - 1) * spacing) / 2;

                    // Draw Lattice
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const x = startX + c * spacing;
                            const y = startY + r * spacing;

                            ctx.beginPath();
                            ctx.arc(x, y, 6, 0, Math.PI * 2);
                            ctx.fillStyle = PALETTE.lattice;
                            ctx.fill();
                        }
                    }

                    // Exciton Center (Snapped to lattice point [3,3])
                    // Matched to the same grid logic as Frenkel
                    const centerCol = 3;
                    const centerRow = 3;
                    const cx = startX + centerCol * spacing;
                    const cy = startY + centerRow * spacing;

                    // Hole
                    ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI * 2);
                    ctx.fillStyle = PALETTE.ion;
                    ctx.shadowBlur = 15; ctx.shadowColor = PALETTE.ion;
                    ctx.fill(); ctx.shadowBlur = 0;

                    // Electron (Large Orbit)
                    const radius = 100;
                    const ex = cx + Math.cos(time * 0.05) * radius;
                    const ey = cy + Math.sin(time * 0.05) * radius;

                    // Electron Wavefunction Cloud
                    const grad = ctx.createRadialGradient(cx, cy, 20, cx, cy, radius + 20);
                    grad.addColorStop(0, "rgba(77, 77, 255, 0.0)");
                    grad.addColorStop(0.8, "rgba(77, 77, 255, 0.15)");
                    grad.addColorStop(1, "rgba(77, 77, 255, 0)");
                    ctx.beginPath(); ctx.arc(cx, cy, radius + 20, 0, Math.PI * 2);
                    ctx.fillStyle = grad; ctx.fill();

                    // Electron Particle
                    ctx.beginPath(); ctx.arc(ex, ey, 6, 0, Math.PI * 2);
                    ctx.fillStyle = PALETTE.electron; ctx.fill();

                    // Field lines (faint)
                    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(ex, ey);
                    ctx.strokeStyle = "rgba(77, 77, 255, 0.2)"; ctx.lineWidth = 1; ctx.stroke();

                    time++;
                    window.anims.wannier = requestAnimationFrame(animate);
                }
                animate();
            }

            initFrenkel();
            initWannier();
        }

        document.addEventListener("DOMContentLoaded", () => {

            /* -----------------------------------------
            1. Lazy-load plots (FIXED & CLEAN)
            ----------------------------------------- */
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {

                    if (!entry.isIntersecting) return;
                    if (entry.target.dataset.loaded === "true") return;

                    const containerId = entry.target.id;
                    const plotKey = entry.target.dataset.plotKey;
                    const spec = window.plotSpecs?.[plotKey];

                    if (!spec) {
                        console.error(
                            `CRITICAL ERROR: <div id="${containerId}"> has data-plot-key="${plotKey}", but window.plotSpecs["${plotKey}"] is missing!`
                        );
                        return;
                    }

                    loadMultiFilePlot(containerId, spec.curves, spec.settings);
                    entry.target.dataset.loaded = "true";
                });
            }, { threshold: 0.25 });

            document.querySelectorAll(".plot-box").forEach(box => observer.observe(box));

            /* -----------------------------------------
            2. Plot zoom modal
            ----------------------------------------- */
            const pltmodal = document.getElementById("plot-modal");
            const modalContent = document.getElementById("plot-modal-content");

            document.querySelectorAll(".plot-box").forEach(box => {
                box.addEventListener("click", () => {

                    pltmodal.classList.remove("hidden");

                    const plotKey = box.dataset.plotKey;
                    if (!plotKey) return;

                    const spec = window.plotSpecs[plotKey];
                    if (!spec) return;

                    loadMultiFilePlot("plot-modal-content", spec.curves, {
                        ...spec.settings
                    });
                });
            });

            pltmodal.addEventListener("click", (e) => {
                if (e.target === pltmodal) {
                    pltmodal.classList.add("hidden");
                    Plotly.purge("plot-modal-content");
                }
            });

            /* -----------------------------------------
            SHIFT + CLICK ‚Üí NAVIGATE TO DETAIL SLIDE
            ----------------------------------------- */
            document.querySelectorAll(".plot-box").forEach(box => {
                box.addEventListener("click", e => {

                    if (!e.shiftKey) return;

                    e.preventDefault();
                    e.stopPropagation();

                    const targetId = box.dataset.targetSlide;
                    if (!targetId) return;

                    lastOverviewSlide = currentSlide;
                    goToSlideById(targetId);

                }, true); // capture phase
            });

            /* -----------------------------------------
            3. Image zoom modal (GLOBAL, layout-agnostic)
            ----------------------------------------- */
            const modal = document.getElementById("mediaZoomModal");
            const modalImg = document.getElementById("mediaZoomImg");
            const modalVideo = document.getElementById("mediaZoomVideo");

            function closeModal() {
                modal.style.display = "none";
                modalImg.style.display = "none";
                modalVideo.style.display = "none";
                modalVideo.pause();
                modalVideo.src = "";

                // --- CLEANUP ---
                // Clear the custom filters so they don't apply to the next image
                modalImg.style.filter = "";
                modalVideo.style.filter = "";
            }

            /* ----------------------------
            IMAGE ZOOM (Dual Presets)
            ---------------------------- */
            document.addEventListener("click", e => {
                const img = e.target.closest("img");
                if (!img) return;
                if (img.closest(".no-zoom")) return;

                /* ================================
                SHIFT + CLICK ‚Üí NAVIGATE
                ================================ */
                if (e.shiftKey) {
                    const navBox = img.closest("[data-target-slide]");
                    if (!navBox) return;

                    e.preventDefault();
                    e.stopPropagation();

                    lastOverviewSlide = currentSlide;
                    goToSlideById(navBox.dataset.targetSlide);
                    return; // üîë do NOT open zoom
                }

                /* ================================
                NORMAL CLICK ‚Üí IMAGE ZOOM
                ================================ */
                e.stopPropagation();

                modalImg.src = img.src;
                modalImg.style.display = "block";
                modalVideo.style.display = "none";

                const isMode1 = img.classList.contains("img-dark-mode1");
                const isMode2 = img.classList.contains("img-dark-mode2");

                if (isMode1 || isMode2) {
                    let defaults = isMode1
                        ? { hue: "180deg", sat: "6", bright: "0.7", con: "1.6" }
                        : { hue: "180deg", sat: "1.5", bright: "1.0", con: "1.1" };

                    const hue = img.dataset.hue || defaults.hue;
                    const sat = img.dataset.sat || defaults.sat;
                    const bright = img.dataset.bright || defaults.bright;
                    const con = img.dataset.con || defaults.con;

                    modalImg.style.filter =
                        `invert(0.88) hue-rotate(${hue}) saturate(${sat}) brightness(${bright}) contrast(${con})`;
                } else {
                    modalImg.style.filter = "none";
                }

                modal.style.display = "flex";
            });


            /* ----------------------------
            VIDEO ZOOM (Dual Presets)
            ---------------------------- */
            document.addEventListener("click", e => {
                const video = e.target.closest("video");
                if (!video) return;
                if (video.closest(".no-zoom")) return;

                e.stopPropagation();

                modalVideo.src = video.currentSrc || video.src;
                modalVideo.style.display = "block";
                modalImg.style.display = "none";

                const isMode1 = video.classList.contains("img-dark-mode1");
                const isMode2 = video.classList.contains("img-dark-mode2");

                if (isMode1 || isMode2) {
                    let defaults;
                    if (isMode1) {
                        defaults = { hue: "180deg", sat: "6", bright: "0.7", con: "1.6" };
                    } else {
                        defaults = { hue: "180deg", sat: "1.5", bright: "1.0", con: "1.1" };
                    }

                    const hue = video.dataset.hue || defaults.hue;
                    const sat = video.dataset.sat || defaults.sat;
                    const bright = video.dataset.bright || defaults.bright;
                    const con = video.dataset.con || defaults.con;

                    modalVideo.style.filter = `invert(0.88) hue-rotate(${hue}) saturate(${sat}) brightness(${bright}) contrast(${con})`;
                } else {
                    modalVideo.style.filter = "none";
                }

                modal.style.display = "flex";
                modalVideo.play();
            });
            /* ----------------------------
            CLOSE MODAL (PRESERVED FIX)
            ---------------------------- */
            modal.addEventListener("click", (e) => {
                // --- CHANGE B: TARGET CHECK ---
                // Only close if we clicked the black background, NOT the image itself
                if (e.target === modal) {
                    closeModal();
                }
            });

            /* Optional: Stop clicks on the image/video from bubbling up at all */
            [modalImg, modalVideo].forEach(el => {
                el.addEventListener("click", e => e.stopPropagation());
            });

            document.addEventListener("keydown", e => {
                if (e.key === "Escape") closeModal();
            });

            /* -----------------------------------------
            4. Cursor Halo
            ----------------------------------------- */
            const halo = document.getElementById("cursor-halo");

            document.addEventListener("mousemove", e => {
                halo.style.left = e.clientX + "px";
                halo.style.top  = e.clientY + "px";

                // show halo while Ctrl is held
                halo.style.opacity = e.ctrlKey ? "1" : "0";
            });

            // CITATIONS
                const citations = {
                // Groundstate Tables
                lattice_constants: "Philipp Haas, Fabien Tran, and Peter Blaha. Calculation of the lattice constant of solids with semilocal functionals. Phys. Rev. B, 79:085104, Feb 2009. ",
                LiF_bandgap_1: "F. Bechstedt. Many-Body Approach to Electronic Excitations, volume 181. 01 2015.",
                LiF_bandgap_2: "M. Piacentini, D. W. Lynch, and C. G. Olson. Thermoreflectance of lif between 12 and 30 ev. Phys. Rev. B, 13:5530-5543, Jun 1976.",
                MgO_CaO_bandgap: "R. C. Whited, C.J. Flaten, and W. C.Walker. Exciton thermoreflectance of MgO and CaO. Solid State Communications, 13(11):1903-1905, 1973.",
                MgO_paper: "D. M. Roessler and W. C. Walker. Electronic spectrum and ultraviolet optical properties of crystalline MgO., Phys. Rev., 159:733-738, Jul 1967.",
                CaO_bandgap_2: "Yoshio Kaneko and Takao Koda. New developments in iia-vib (alkaline-earth chalcogenide) binary semiconductors. Journal of Crystal Growth, 86(1):72-78, 1988.",
                ZnO_bandgap_1: "Dirk Vogel, Peter Kr√ºger. Ab initio electronic-structure calculations for ii-vi semiconductors using self-interaction-corrected pseudopotentials. and Johannes Pollmann. Phys. Rev. B, 52:R14316-R14319, Nov 1995.",

                LiF_ZnO_epsInf: "F. Bernardini and V. Fiorentini.  Electronic dielectric constants of insulatorsby the polarization method. Phys. Rev. B, 1386795 (1998).",
                dielectric_constants: "W. Martienssen and H. Warlimont, Springer Handbook of Condensed Matter and Materials Data, Vol. 1 (2005).",
                CaO_epsInf: "J.L. Jacobson and E.R. Nixon. Infrared dielectric response and lattice vibrations of calcium and strontium oxides. Journal of Physics and Chemistry of Solids 29, 967 (1968)."

            };

            const tooltip = document.getElementById("cite-tooltip");

            if (!tooltip) {
                console.error("cite-tooltip div not found");
                return;
            }

            // --- Auto-number citations ---
            const citeOrder = [];
            const citeNumber = {};

            document.querySelectorAll(".cite").forEach(cite => {
                const key = cite.dataset.cite;

                if (!(key in citeNumber)) {
                    citeOrder.push(key);
                    citeNumber[key] = citeOrder.length;
                }

                cite.textContent = `[${citeNumber[key]}]`;
            });

            document.addEventListener("click", e => {

                const citeEl = e.target.closest(".cite");
                if (citeEl) {
                    const key = citeEl.dataset.cite;
                    tooltip.textContent = citations[key] || "Reference not found.";

                    const rect = citeEl.getBoundingClientRect();
                    tooltip.style.left = rect.left + "px";
                    tooltip.style.top  = rect.bottom + 6 + "px";

                    tooltip.style.display = "block";
                    e.stopPropagation();
                    return;
                }

                tooltip.style.display = "none";

            }, true); // capture phase

            // -----------------------------------------
            // TRUE INFINITE REFERENCES SCROLL
            // -----------------------------------------
            const lane1 = document.getElementById("ref-lane-1");
            const lane2 = document.getElementById("ref-lane-2");

            if (lane1 && lane2) {

                // Build reference list once
                const buildRefs = () => {
                    const frag = document.createDocumentFragment();

                    citeOrder.forEach(key => {
                        if (!citations[key]) return; // üîë remove "not found"

                        const p = document.createElement("p");
                        p.textContent = citations[key];
                        frag.appendChild(p);
                    });

                    return frag;
                };

                lane1.appendChild(buildRefs());
                lane2.appendChild(buildRefs());

                // Position lanes
                let y1 = 0;
                let y2 = lane1.offsetHeight;

                const speed = 1; // px per frame (tune this)

                function animate() {

                    y1 -= speed;
                    y2 -= speed;

                    // When lane 1 fully leaves screen ‚Üí move it under lane 2
                    if (y1 + lane1.offsetHeight < 0) {
                        y1 = y2 + lane2.offsetHeight;
                    }

                    // Same for lane 2
                    if (y2 + lane2.offsetHeight < 0) {
                        y2 = y1 + lane1.offsetHeight;
                    }

                    lane1.style.transform = `translate(-50%, ${y1}px)`;
                    lane2.style.transform = `translate(-50%, ${y2}px)`;

                    requestAnimationFrame(animate);
                }

                animate();
            }

            // TABLE zoom

            document.addEventListener("click", e => {

                const panel = document.querySelector(".table-panel.expanded");

                // Click INSIDE expanded table ‚Üí do nothing
                if (panel && panel.contains(e.target)) {
                    e.stopPropagation();
                    return;
                }

                // Click on collapsed table ‚Üí expand
                const collapsed = e.target.closest(".table-panel:not(.expanded)");
                if (collapsed) {
                    collapsed.classList.add("expanded");
                    e.stopPropagation();
                    return;
                }

                // Click anywhere else ‚Üí collapse
                document.querySelectorAll(".table-panel.expanded")
                    .forEach(p => p.classList.remove("expanded"));

            }, true);

            /* VIDEO OVERLAY */
             const overlay = document.getElementById("video-overlay");
    const video   = document.getElementById("overlay-video");

    document.querySelectorAll(".video-play-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
            e.stopPropagation();

            const src = btn.dataset.videoSrc;
            video.src = src;
            video.currentTime = 0;
            video.play();

            overlay.classList.remove("hidden");
        });
    });

    /* Close when clicking outside video */
    overlay.addEventListener("click", () => {
        closeVideo();
    });

    /* Prevent click inside video from closing */
    video.addEventListener("click", e => e.stopPropagation());

    /* Close on ESC */
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeVideo();
    });

    function closeVideo() {
        video.pause();
        video.src = "";
        overlay.classList.add("hidden");
    }

        });


        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
            // Get the ID of the slide we just switched to
            const activeSlideId = slides[currentSlide].id;

            // Trigger animations based on ID
            if (activeSlideId === 'slide-DFT-intro1') initMbDftAnim();
            if (activeSlideId === 'slide-GW-green')   initGreensAnim();
            if (activeSlideId === 'slide-excitons-type') init_excitons();

            if (currentSlide === 3) resizeExcitation();
        }, 200);
        });

        window.addEventListener('load', () => { updateProgress(); });

        function toggleOverlay(button) {
            const index = button.dataset.ov;

            // Which mode is active?
            const activeMode = document.querySelector('.mode-container.active');
            if (!activeMode) return;

            const overlay = activeMode.querySelector(`#${activeMode.dataset.mode}_ov${index}`);
            if (!overlay) return;

            const isActive = overlay.classList.contains('active');

            // Reset only inside active mode
            activeMode.querySelectorAll('.overlay').forEach(o => o.classList.remove('active'));
            document.querySelectorAll('.overlay-controls button')
                .forEach(b => b.classList.remove('active'));

            if (!isActive) {
                overlay.classList.add('active');
                button.classList.add('active');
            }
        }

        function toggleMode(mode) {
            const slide = document.getElementById('slide-defects-overlay');

            // Switch containers
            document.querySelectorAll('.mode-container').forEach(c => {
                c.classList.toggle('active', c.dataset.mode === mode);
            });

            // Switch mode buttons
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.toggle('active', b.textContent === mode);
            });

            // Reset overlays
            document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active'));
            document.querySelectorAll('.overlay-controls button')
                .forEach(b => b.classList.remove('active'));

            // Update title
            slide.querySelector('h2').textContent =
                `Defectos: LiF - Estructura Electr√≥nica (${mode})`;

            // üîë Update mode for CSS styling
            slide.dataset.mode = mode;
        }



    </script>


    <!-- IMAGE ZOOM MODAL -->
    <div id="mediaZoomModal" style="
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(4px);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    ">
        <!-- image -->
        <img id="mediaZoomImg" style="
            max-width: 90vw;
            max-height: 90vh;
            display: none;
            border-radius: 8px;
            box-shadow: 0 0 20px #000;
        ">

        <!-- video -->
        <video id="mediaZoomVideo" controls autoplay style="
            max-width: 90vw;
            max-height: 90vh;
            display: none;
            border-radius: 8px;
            box-shadow: 0 0 20px #000;
            background: #000;">
        </video>
    </div>


    <div id="plot-modal" class="plot-modal hidden">
        <div id="plot-modal-content" class="plot-modal-content"></div>
    </div>

</body>
</html>

<!--
    SET UP LOCAL SERVER:
    Open a terminal inside the folder where your HTML is, then: python3 -m http.server 5500
    Then open in Chrome: http://127.0.0.1:5500/
-->